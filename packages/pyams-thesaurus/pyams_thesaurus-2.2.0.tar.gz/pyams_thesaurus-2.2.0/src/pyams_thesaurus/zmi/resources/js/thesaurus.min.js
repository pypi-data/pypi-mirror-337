"use strict";void 0===window.$&&(window.$=MyAMS.$);const thesaurus={init:()=>{let a=$("[data-ams-thesaurus-css]").data("ams-thesaurus-css");a||(a="/--static--/pyams_thesaurus/css/thesaurus.css"),MyAMS.core.getCSS(a,"pyams_template").catch(()=>{console.warning(`Can't load thesaurus CSS: ${a}`)})},tree:{init:()=>{$(document).off("click","i.extract-checker"),$(document).on("click","i.extract-checker",a=>{const e=$(a.currentTarget);if(e.hasClass("disabled"))return;const t=$("span.term",e.closest("div").siblings("span"));MyAMS.require("ajax").then(()=>{MyAMS.ajax.post("switch-extract.json",{term:t.text(),extract:e.data("ams-extract-name")}).then(a=>{a.status?MyAMS.ajax.handleJSON(a):a.used?($(`>li >div i.extract-checker[data-ams-extract-name="${a.extract}"]`,e.closest("div").siblings("ul.group")).replaceWith($("<i></i>").addClass("extract-checker far fa-fw fa-square").css("color",`#${a.color}`).attr("data-ams-extract-name",a.extract)),e.replaceWith($("<i></i>").addClass("extract-checker fas fa-fw fa-square used").css("color",`#${a.color}`).attr("data-ams-extract-name",a.extract))):($(`i.extract-checker[data-ams-extract-name="${a.extract}"]`,e.closest("div").siblings("ul.group")).replaceWith($("<i></i>").addClass("extract-checker fas fa-fw fa-square disabled").css("color","silver").attr("data-ams-extract-name",a.extract)),e.replaceWith($("<i></i>").addClass("extract-checker far fa-fw fa-square").css("color",`#${a.color}`).attr("data-ams-extract-name",a.extract)))})})})},search:a=>{const e=$(a.currentTarget).val();e&&MyAMS.thesaurus.tree.findTerm(null,{term:e})},displaySubNodes:(a,e,t)=>{void 0===t&&(t=$(`span.term:withtext("${a}")`).siblings("i[data-ams-click-handler]"));const s=t.parents("span.label").siblings("ul.group"),r=s.closest("ul.group").closest("li");s.empty();for(const a of e){const e=$("<li></li>");a.extracts.reverse();for(const t of a.extracts){const a=$("<div></div>").addClass("float-right mr-2").appendTo(e),s=$("<i></i>").attr("data-ams-extract-name",t.name).addClass("fas fa-fw fa-square extract-checker").css("color",`#${t.color}`);if($(`>div i.extract-checker[data-ams-extract-name="${t.name}"]`,r).hasClass("used")){t.used?s.addClass("used"):s.removeClass("fas").addClass("far");const a=$("i.switcher",`table.extracts tr[data-ams-element-name="${t.name}"]`),e=$("svg",a);(e.exists()?e:a).hasClass("fa-eye")||s.css("visibility","hidden")}else s.addClass("disabled").css("color","silver");s.appendTo(a)}const t=$("<span></span>").addClass("label py-1").addClass(a.css_class).attr("data-ams-url",a.view).attr("data-toggle","modal");if(a.expand&&$("<i></i>").addClass("fas fa-fw fa-plus-circle").attr("data-ams-click-handler","MyAMS.thesaurus.tree.expandOrCollapse").attr("data-ams-stop-propagation",!0).appendTo(t),$("<span></span>").addClass("term").html(a.label).appendTo(t),t.appendTo(e),a.extensions)for(const t of a.extensions)t.active?$("<i></i>").addClass(t.icon).addClass("extension hint mx-2 my-1 float-right mouse-pointer").addClass("opaque text-primary").attr("data-ams-url",t.view).attr("data-toggle","modal").attr("title",t.title).appendTo(e):$("<i></i>").addClass(t.icon).addClass("extension hint mx-2 my-1 float-right mouse-pointer").addClass("text-secondary").attr("data-ams-click-handler","MyAMS.thesaurus.tree.switchExtension").attr("data-ams-extension-name",t.name).attr("title",t.title).appendTo(e);$("<ul></ul>").addClass("hidden group").appendTo(e),e.appendTo(s),a.subnodes&&MyAMS.thesaurus.tree.displaySubNodes(a.label,a.subnodes)}s.removeClass("hidden"),t.replaceWith($("<i></i>").addClass("fas fa-fw fa-minus-circle").attr("data-ams-click-handler","MyAMS.thesaurus.tree.expandOrCollapse").attr("data-ams-stop-propagation","true"))},expandOrCollapse:a=>{let e=$(a.currentTarget);"i"!==a.currentTarget.tagName.toLowerCase()&&(e=e.parents("i"));let t=e,s=$("svg",t);if(s.exists()&&(t=s),t.hasClass("fa-plus-circle")){const a=t.parents(".tree");MyAMS.thesaurus.tree.expandHandler(e,a)}else MyAMS.thesaurus.tree.collapseHandler(e)},expandHandler:(a,e)=>{const t=a.siblings("span.term").text(),s=$("<i></i>").addClass("fas fa-fw fa-spinner fa-spin").replaceAll(a);MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${e.data("ams-location")}/get-nodes.json`,{term:t}).then(a=>{MyAMS.thesaurus.tree.displaySubNodes(t,a.nodes,s)})})},collapseHandler:a=>(a.parents("span.label").siblings("ul.group").addClass("hidden"),a=$("<i></i>").addClass("fas fa-fw fa-plus-circle").attr("data-ams-click-handler","MyAMS.thesaurus.tree.expandOrCollapse").attr("data-ams-stop-propagation",!0).replaceAll(a)),findTerm:(a,e)=>new Promise((a,t)=>{MyAMS.require("ajax","alert").then(()=>{MyAMS.ajax.post("get-parent-nodes.json",{term:e.term}).then(e=>{MyAMS.thesaurus.tree.displaySubNodes(e.parent,e.nodes);const t=$(`span.term:withtext("${e.term}")`).parents("span.label");t.exists()?MyAMS.ajax.check($.fn.scrollTo,`${MyAMS.env.baseURL}../ext/jquery-scrollto${MyAMS.env.extext}.js`).then(()=>{$("#main").scrollTo(t,{offset:-15}),t.css("background-color","var(--success)").off("mouseover").on("mouseover",a=>{$(a.target).css("background-color","")})}):e.term&&MyAMS.require("modal").then(()=>{const a=$(".tree").data("ams-location");MyAMS.modal.open(`${a}/++terms++/${e.term}/properties.html`)}),a(t)},t)})}),findMovedTerm:function(a){return new Promise((e,t)=>{MyAMS.thesaurus.tree.findTerm(null,a).then(()=>{e()},t)})},updateTerm:function(a,e){let t,s=$(`span.term:withtext("${e.term}")`).siblings("i[data-ams-click-handler]");const r=$("svg",s);(t=r.exists()?r:s).hasClass("fa-minus-circle")&&(s=MyAMS.thesaurus.tree.collapseHandler(s)),s.click()},removeTerm:function(a,e){$(`span.term:withtext("${e.term}")`).parents("li").first().remove()},switchExtension:a=>{let e=$(a.currentTarget);"i"!==a.currentTarget.tagName.toLowerCase()&&(e=e.parents("i"));const t=e.siblings("span.label").text(),s=e.data("ams-extension-name");MyAMS.require("ajax").then(()=>{MyAMS.ajax.post("switch-extension.json",{term:t,extension:s}).then(a=>{e.tooltip("hide"),e.replaceWith($("<i></i>").addClass(a.icon).addClass("extension hint mx-2 my-1 float-right").addClass("opaque text-primary").attr("data-ams-url",a.view).attr("data-toggle","modal").attr("title",a.title))})})},switchExtract:a=>(function(a,e){const t=$("i",a),s=t.parents("tr:first").data("ams-element-name");let r;r=MyAMS.config.useSVGIcons?$("svg",t):t;const n=$(`i.extract-checker[data-ams-extract-name="${s}"]`);r.hasClass("fa-eye-slash")?(n.css("visibility",""),MyAMS.core.switchIcon(t,"eye-slash","eye")):(n.css("visibility","hidden"),MyAMS.core.switchIcon(t,"eye","eye-slash"))})},widget:{init:function(a){$("input:checked",a).each((a,e)=>{$(e).parents(".terms-box:first").siblings("header").addClass("active")})},updateSelection:a=>{let e;e=a.is&&a.is("form")?$(".terms-box",a):"form"===a.currentTarget.tagName.toLowerCase()?$(".terms-box",$(a.currentTarget)):$(a.currentTarget).parents(".terms-box:first"),$(e.each((a,e)=>{const t=$(e).siblings("header");t.removeClass("active"),$("input:checked",e).exists()&&t.addClass("active")}))}}};window.MyAMS&&(MyAMS.config.modules.push("thesaurus"),MyAMS.thesaurus=thesaurus,console.debug("MyAMS: thesaurus module loaded..."));