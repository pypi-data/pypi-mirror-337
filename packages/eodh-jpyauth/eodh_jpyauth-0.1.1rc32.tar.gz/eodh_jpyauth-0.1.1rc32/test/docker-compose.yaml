services:
  hub:
    build:
      context: ..
      dockerfile: test/jupyterhub/Dockerfile
      args:
        JUPYTERHUB_VERSION: latest
    restart: always
    image: jupyterhub
    container_name: jupyterhub
    networks:
      - jupyterhub-network
    volumes:
      - "../test/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:rw"
      - "jupyterhub-data:/data"
    ports:
      - "8060:8000"
    environment:
      JUPYTERHUB_ADMIN: admin
      JUPYTERHUB_CRYPT_KEY: 7034981f1b2d106eaed55c5ba426d197d9da62c2ddf40767be4cb2bf50ff4c8f
      DOCKER_NETWORK_NAME: jupyterhub-network
      DOCKER_NOTEBOOK_IMAGE: quay.io/jupyter/base-notebook:latest
      DOCKER_NOTEBOOK_DIR: /home/jovyan
      PLATFORM_DOMAIN: jupyterhub:8060
      OAUTH_CLIENT_ID: client
      OAUTH_CLIENT_SECRET: e3rjr7sz9NVuAtRsg74XJUrEWG408o7W
      OAUTH_AUTHORIZE_URL: http://keycloak:8080/realms/test/protocol/openid-connect/auth
      OAUTH_TOKEN_URL: http://keycloak:8080/realms/test/protocol/openid-connect/token
      OAUTH_CALLBACK_URL: http://jupyterhub:8060/hub/oauth_callback
      OAUTH_USERDATA_URL: http://keycloak:8080/realms/test/protocol/openid-connect/userinfo
      OAUTH_USERNAME_CLAIM: preferred_username
      OAUTH_LOGOUT_URL: http://keycloak:8080/realms/test/protocol/openid-connect/logout
      OAUTH_LOGOUT_REDIRECT_URI: http://jupyterhub:8060
  keycloak:
    image: public.ecr.aws/eodh/eodh-keycloak:26.0.4-0.2.5
    command:
      - start-dev
      - --import-realm
      - --features=dynamic-scopes:v1,token-exchange:v1
      - --spi-oauth2-token-exchange-provider=scope-enhanced-token-exchange
    container_name: keycloak
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_LOG_LEVEL: INFO
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/test-realm.json:/opt/keycloak/data/import/test-realm.json
    networks:
      - jupyterhub-network
    restart: always
  workspaces:
    build:
      context: workspaces
      dockerfile: Dockerfile
    container_name: workspaces
    environment:
      ALLOWED_USERS: user
    ports:
      - "8000:8000"
    networks:
      - jupyterhub-network
    restart: always
volumes:
  jupyterhub-data:
networks:
  jupyterhub-network:
    name: jupyterhub-network
