build_test_image:
  image: docker:stable
  stage: build
  tags:
    - privileged
  services:
    - name: docker:dind
  script:
    - docker build --rm -t rospy_yaml_include-tests:latest -f tests/tests.Dockerfile .

run_tests:
  stage: test
  image: rospy_yaml_include-tests:latest
  script:
    - source /ros_entrypoint.sh
    - pip install -r requirements.txt
    - pip install .
    - mkdir -p ~/catkin_ws/src
    - cd ~/catkin_ws/src && catkin_create_pkg rospy_yaml_include_test
    - cp -r $CI_PROJECT_DIR/tests/test_files/ rospy_yaml_include_test/test_files/
    - cd ~/catkin_ws && catkin_make
    - source devel/setup.bash
    - roscore &
    - cd $CI_PROJECT_DIR/tests && pytest --junitxml=report.xml
  artifacts:
    when: always
    paths:
      - tests/report.xml

pypi:
  image: python
  stage: deploy
  script:
    - pip install -r requirements.txt
    - pip install build twine
    - python -m build
    - twine upload --username __token__ --password $PYPI_TOKEN dist/*
  artifacts:
    paths:
      - dist/
  only:
    - tags
