"use strict";(self.webpackChunkjupyterlab_chat_extension=self.webpackChunkjupyterlab_chat_extension||[]).push([[507],{3507:(e,t,s)=>{s.r(t),s.d(t,{ChatPanel:()=>v,ChatWidgetFactory:()=>S,CommandIDs:()=>_,IActiveCellManagerToken:()=>C,IChatFactory:()=>p,IChatPanel:()=>y,IInputToolbarRegistryFactory:()=>b,ISelectionWatcherToken:()=>f,LabChatModel:()=>d,LabChatModelFactory:()=>T,LabChatPanel:()=>M,WidgetConfig:()=>I,YChat:()=>o,chatFileType:()=>m});var a=s(1240),i=s(8397),n=s(4602),h=s(7262),r=s(8e3);class o extends r.YDocument{constructor(e){super(e),this.version="1.0.0",this._usersObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._users.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._users.get(s),type:"change"})}})),this._changed.emit({userChanges:t})},this._messagesObserver=e=>{const t=e.delta;this._changed.emit({messageChanges:t})},this._attachmentsObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._attachments.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._attachments.get(s),type:"change"})}})),this._changed.emit({attachmentChanges:t})},this._metadataObserver=e=>{const t=new Array;e.changes.keys.forEach(((e,s)=>{switch(e.action){case"add":t.push({key:s,newValue:this._metadata.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:e.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:e.oldValue,newValue:this._metadata.get(s),type:"change"})}})),this._changed.emit({metadataChanges:t})},this._users=this.ydoc.getMap("users"),this._users.observe(this._usersObserver),this._messages=this.ydoc.getArray("messages"),this._messages.observe(this._messagesObserver),this._attachments=this.ydoc.getMap("attachments"),this._attachments.observe(this._attachmentsObserver),this._metadata=this.ydoc.getMap("metadata"),this._metadata.observe(this._metadataObserver)}static create(e){return new o(e)}get id(){return this._metadata.get("id")||""}get users(){return h.JSONExt.deepCopy(this._users.toJSON())}get messages(){return h.JSONExt.deepCopy(this._messages.toJSON())}get attachments(){return h.JSONExt.deepCopy(this._attachments.toJSON())}getSource(){return{users:this._users.toJSON(),messages:this._messages.toJSON(),metadata:this._metadata.toJSON()}}setSource(e){e&&this.transact((()=>{var t,s,a;(null!==(t=e.messages)&&void 0!==t?t:[]).forEach((e=>{this._messages.push([e])}));const i=null!==(s=e.users)&&void 0!==s?s:{};Object.entries(i).forEach((([e,t])=>this._users.set(e,t)));const n=null!==(a=e.metadata)&&void 0!==a?a:{};Object.entries(n).forEach((([e,t])=>this._metadata.set(e,t)))}))}getUser(e){if(e)return this._users.get(e)}setUser(e){this.transact((()=>{this._users.set(e.username,e)}))}getMessage(e){return this._messages.get(e)}addMessage(e){this.transact((()=>{this._messages.push([e])}))}updateMessage(e,t){this.transact((()=>{this._messages.delete(e),this._messages.insert(e,[t])}))}getMessageIndex(e){return this._messages.toArray().findIndex((t=>t.id===e))}deleteMessage(e){this.transact((()=>{this._messages.delete(e)}))}getAttachment(e){return this._attachments.get(e)}setAttachment(e){var t;const s=(null===(t=Array.from(this._attachments.entries()).find((([t,s])=>s.type===e.type&&s.value===e.value)))||void 0===t?void 0:t[0])||h.UUID.uuid4();return this.transact((()=>{this._attachments.set(s,e)})),s}}class d extends a.ChatModel{constructor(e){super(e),this.collaborative=!0,this.onInputChanged=(e,t)=>{if(!t||!this.config.sendTypingNotification)return;const s=this.sharedModel.awareness;null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting),s.setLocalStateField("isWriting",!0),this._timeoutWriting=window.setTimeout((()=>{this._resetWritingStatus()}),1e3)},this.onAwarenessChange=()=>{const e=[],t=this.sharedModel.awareness.getStates();for(const s of t.keys()){const a=t.get(s);a&&a.user&&a.user.username!==this.user.username&&a.isWriting&&e.push(a.user)}this.updateWriters(e)},this._onchange=(e,t)=>{if(t.messageChanges){const e=t.messageChanges;let s=0;e.forEach((e=>{if(e.retain)s+=e.retain;else if(e.insert){const t=e.insert.map((e=>{const{sender:t,attachments:s,...a}=e,i={...a,sender:this.sharedModel.getUser(t)||{username:"User undefined"}};if(s){const e=[];s.forEach((t=>{const s=this.sharedModel.getAttachment(t);s&&e.push(s)})),e.length&&(i.attachments=e)}return i}));this.messagesInserted(s,t),s+=t.length}else e.delete&&this.messagesDeleted(s,e.delete)}))}t.metadataChanges&&t.metadataChanges.forEach((e=>{"id"===e.key&&(this.id=e.newValue)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._ready=new h.PromiseDelegate,this._dirty=!1,this._readOnly=!1,this._disposed=new n.Signal(this),this._contentChanged=new n.Signal(this),this._stateChanged=new n.Signal(this),this._timeoutWriting=null,this._user=e.user||{username:"user undefined"};const{widgetConfig:t,sharedModel:s}=e;this._sharedModel=s||o.create(),this.sharedModel.changed.connect(this._onchange,this),this.config=t.config,t.configChanged.connect(((e,t)=>{this.config=t})),this.sharedModel.awareness.on("change",this.onAwarenessChange),this.input.valueChanged.connect(this.onInputChanged)}get user(){return this._user}get sharedModel(){return this._sharedModel}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get disposed(){return this._disposed}set id(e){super.id=e,e&&this._ready.resolve()}dispose(){this.isDisposed||(super.dispose(),this._sharedModel.dispose(),this._disposed.emit(),n.Signal.clearData(this))}toString(){return JSON.stringify({},null,2)}fromString(e){}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}messagesInserted(e,t){this._ready.promise.then((()=>{super.messagesInserted(e,t)}))}sendMessage(e){this._resetWritingStatus(),null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting);const t={type:"msg",id:h.UUID.uuid4(),body:e.body,time:Date.now()/1e3,sender:this._user.username,raw_time:!0};if(this.sharedModel.getUser(this._user.username)!==this._user&&this.sharedModel.setUser(this._user),this.input.attachments.length){const e=this.input.attachments.map((e=>this.sharedModel.setAttachment(e)));t.attachments=e,this.input.clearAttachments()}this.sharedModel.addMessage(t)}clearMessages(){}updateMessage(e,t){var s;const a=this.sharedModel.getMessageIndex(e);let i=this.sharedModel.getMessage(a);if(i)i.body=t.body,i.edited=!0;else{const s=t.sender.username;i={type:"msg",id:e||h.UUID.uuid4(),body:t.body,time:t.time||Date.now()/1e3,sender:s,edited:!0}}const n=null===(s=t.attachments)||void 0===s?void 0:s.map((e=>this.sharedModel.setAttachment(e)));n&&(i.attachments=n),this.sharedModel.updateMessage(a,i)}deleteMessage(e){const t=this.sharedModel.getMessageIndex(e),s=this.sharedModel.getMessage(t);s?(s.body="",s.deleted=!0,this.sharedModel.updateMessage(t,s)):console.error("The message to delete does not exist")}_resetWritingStatus(){const e=this.sharedModel.awareness,t=e.getLocalState();null==t||delete t.isWriting,e.setLocalState(t),this._timeoutWriting=null}}var c=s(4979),l=s(4178),g=s(5726),u=s.n(g);const m={name:"chat",displayName:"Chat",mimeTypes:["text/json","application/json"],extensions:[".chat"],fileFormat:"text",contentType:"chat",icon:a.chatIcon},p=new h.Token("jupyterlab-chat:IChatFactory"),_={createChat:"jupyterlab-chat:create",openChat:"jupyterlab-chat:open",moveToSide:"jupyterlab-chat:moveToSide",markAsRead:"jupyterlab-chat:markAsRead",focusInput:"jupyterlab-chat:focusInput"},y=new h.Token("jupyterlab-chat:IChatPanel"),C=new h.Token("jupyterlab-chat:IActiveCellManager"),f=new h.Token("jupyterlab-chat:ISelectionWatcher"),b=new h.Token("jupyterlab-chat:IInputToolbarRegistryFactory"),w="jp-lab-chat-title-unread";class M extends i.DocumentWidget{constructor(e){super(e),this._unreadChanged=(e,t)=>{t.length?this.title.className.includes(w)||(this.title.className+=` ${w}`):this.title.className=this.title.className.replace(w,"")},this.addClass("jp-lab-chat-main-panel"),this.model.name=this.context.localPath,this.model.unreadChanged.connect(this._unreadChanged)}dispose(){this.model.unreadChanged.disconnect(this._unreadChanged),this.context.dispose(),this.content.dispose(),super.dispose()}get model(){return this.context.model}}class v extends l.SidePanel{constructor(e){super(e),this.updateChatList=async()=>{const e=m.extensions[0];this._drive.get(this._defaultDirectory).then((t=>{const s={};t.content.filter((t=>"file"===t.type&&t.name.endsWith(e))).forEach((t=>{s[c.PathExt.basename(t.name,e)]=t.path})),this._chatNamesChanged.emit(s)})).catch((e=>console.error("Error getting the chat files from drive",e)))},this._chatSelected=e=>{const t=e.target,s=t.value;"-"!==t.options[t.selectedIndex].textContent&&(this._commands.execute(_.openChat,{filepath:s,inSidePanel:!0}),e.target.selectedIndex=0)},this._chatNamesChanged=new n.Signal(this),this.addClass("jp-lab-chat-sidepanel"),this._commands=e.commands,this._drive=e.drive,this._rmRegistry=e.rmRegistry,this._themeManager=e.themeManager,this._defaultDirectory=e.defaultDirectory,this._chatCommandRegistry=e.chatCommandRegistry,this._attachmentOpenerRegistry=e.attachmentOpenerRegistry,this._inputToolbarFactory=e.inputToolbarFactory;const t=new l.CommandToolbarButton({commands:this._commands,id:_.createChat,args:{inSidePanel:!0},icon:l.addIcon});t.addClass("jp-lab-chat-add"),this.toolbar.addItem("createChat",t),this._openChat=l.ReactWidget.create(u().createElement(x,{chatNamesChanged:this._chatNamesChanged,handleChange:this._chatSelected.bind(this)})),this._openChat.addClass("jp-lab-chat-open"),this.toolbar.addItem("openChat",this._openChat),this.content.expansionToggled.connect(this._onExpansionToggled,this)}get defaultDirectory(){return this._defaultDirectory}set defaultDirectory(e){e!==this._defaultDirectory&&(this._defaultDirectory=e,this.updateChatList(),this.widgets.forEach((t=>{t.defaultDirectory=e})))}addChat(e){const t=this.content;for(let e=0;e<this.widgets.length;e++)t.collapse(e);let s;this._inputToolbarFactory&&(s=this._inputToolbarFactory.create());const i=new a.ChatWidget({model:e,rmRegistry:this._rmRegistry,themeManager:this._themeManager,chatCommandRegistry:this._chatCommandRegistry,attachmentOpenerRegistry:this._attachmentOpenerRegistry,inputToolbarRegistry:s});return this.addWidget(new k({widget:i,commands:this._commands,path:e.name,defaultDirectory:this._defaultDirectory})),i}openIfExists(e){const t=this._getChatIndex(e);return t>-1&&this._expandChat(t),t>-1}onAfterShow(e){var t;null===(t=this._openChat.renderPromise)||void 0===t||t.then((()=>this.updateChatList()))}_getChatIndex(e){return this.widgets.findIndex((t=>t.path===e))}_expandChat(e){this.widgets[e].isVisible||this.content.expand(e)}_onExpansionToggled(e,t){if(this.widgets[t].isVisible)for(let s=0;s<this.widgets.length;s++)s!==t&&e.collapse(s)}}class k extends l.PanelWithToolbar{constructor(e){var t;super(e),this._unreadChanged=(e,t)=>{this._markAsRead.enabled=t.length>0},this.addWidget(e.widget),this.addClass("jp-lab-chat-section"),this._defaultDirectory=e.defaultDirectory,this._path=e.path,this._updateTitle(),this.toolbar.addClass("jp-lab-chat-toolbar"),this._markAsRead=new l.ToolbarButton({icon:a.readIcon,iconLabel:"Mark chat as read",className:"jp-mod-styled",onClick:()=>this.model.unreadMessages=[]});const s=new l.ToolbarButton({icon:l.launchIcon,iconLabel:"Move the chat to the main area",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),e.commands.execute(_.openChat,{filepath:this._path}),this.dispose()}}),i=new l.ToolbarButton({icon:l.closeIcon,iconLabel:"Close the chat",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),this.dispose()}});this.toolbar.addItem("jupyterlabChat-markRead",this._markAsRead),this.toolbar.addItem("jupyterlabChat-moveMain",s),this.toolbar.addItem("jupyterlabChat-close",i),null===(t=this.model.unreadChanged)||void 0===t||t.connect(this._unreadChanged),this._markAsRead.enabled=this.model.unreadMessages.length>0,e.widget.node.style.height="100%"}get path(){return this._path}set defaultDirectory(e){this._defaultDirectory=e,this._updateTitle()}get model(){return this.widgets[0].model}dispose(){var e;null===(e=this.model.unreadChanged)||void 0===e||e.disconnect(this._unreadChanged),super.dispose()}_updateTitle(){const e=!this._defaultDirectory||!c.PathExt.relative(this._defaultDirectory,this._path).startsWith(".."),t=new RegExp(`${m.extensions[0]}$`,"g");this.title.label=(e?this._defaultDirectory?c.PathExt.relative(this._defaultDirectory,this._path):this._path:"/"+this._path).replace(t,""),this.title.caption=this._path}}function x({chatNamesChanged:e,handleChange:t}){const[s,a]=(0,g.useState)({});return e.connect(((e,t)=>{a(t)})),u().createElement(l.HTMLSelect,{onChange:t},u().createElement("option",{value:"-"},"Open a chat"),Object.keys(s).map((e=>u().createElement("option",{value:s[e]},e))))}class I{constructor(e){this._configChanged=new n.Signal(this),this._config=e}get config(){return this._config}set config(e){this._config={...this._config,...e},this._configChanged.emit(e)}get configChanged(){return this._configChanged}}class S extends i.ABCWidgetFactory{constructor(e){super(e),this._themeManager=e.themeManager,this._rmRegistry=e.rmRegistry,this._chatCommandRegistry=e.chatCommandRegistry,this._attachmentOpenerRegistry=e.attachmentOpenerRegistry,e.inputToolbarFactory&&(this._inputToolbarRegistry=e.inputToolbarFactory.create())}createNewWidget(e){return e.rmRegistry=this._rmRegistry,e.themeManager=this._themeManager,e.chatCommandRegistry=this._chatCommandRegistry,e.attachmentOpenerRegistry=this._attachmentOpenerRegistry,e.inputToolbarRegistry=this._inputToolbarRegistry,new M({context:e,content:new a.ChatWidget(e)})}}class T{constructor(e){var t,s,a;this.collaborative=!0,this._disposed=!1,this._user=e.user,this._widgetConfig=e.widgetConfig,this._commands=e.commands,this._activeCellManager=null!==(t=e.activeCellManager)&&void 0!==t?t:null,this._selectionWatcher=null!==(s=e.selectionWatcher)&&void 0!==s?s:null,this._documentManager=null!==(a=e.documentManager)&&void 0!==a?a:null}get name(){return"chat"}get contentType(){return"chat"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new d({...e,user:this._user,widgetConfig:this._widgetConfig,commands:this._commands,activeCellManager:this._activeCellManager,selectionWatcher:this._selectionWatcher,documentManager:this._documentManager})}}}}]);