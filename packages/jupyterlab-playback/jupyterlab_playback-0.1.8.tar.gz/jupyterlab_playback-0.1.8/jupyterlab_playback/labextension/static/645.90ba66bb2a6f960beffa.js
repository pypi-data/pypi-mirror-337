"use strict";(self.webpackChunkjupyterlab_playback=self.webpackChunkjupyterlab_playback||[]).push([[645],{645:(e,t,o)=>{o.r(t),o.d(t,{default:()=>w});var n=o(158),a=o(752),i=o(120),l=o(256),s=o(979),d=o(916);async function r(e="",t={}){const o=d.ServerConnection.makeSettings(),n=s.URLExt.join(o.baseUrl,"jupyterlab-playback",e);let a;try{a=await d.ServerConnection.makeRequest(n,t,o)}catch(e){throw new d.ServerConnection.NetworkError(e)}let i=await a.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new d.ServerConnection.ResponseError(a,i.message||i);return i}var c=o(813),u=o(24),m=o(195);const p=e=>e?e.map((e=>e.command.join("+"))).join("\n"):"",g=(e,t)=>{const o=e.split("\n"),n=o.length||0,a=[];if("code"===t)for(let e=0;e<n;e++){const t=o[e];/^\s*#/.test(t)?a.push({command:["TYPE","AUDIO"]}):/^\s*$/.test(t)?a.push({command:["PAUSE500"]}):a.push({command:["TYPE"]})}else if("markdown"===t)for(let e=0;e<n;e++){const t=o[e];/^\s*#/.test(t)?a.push({command:[]}):/^\s*$/.test(t)||/^\s*!/.test(t)?a.push({command:["PAUSE500"]}):a.push({command:["AUDIO"]})}return{map:a,doc:p(a)}},h=(e,t)=>new Promise((o=>{const n=()=>{const a=e.content.widgets[t].node.getElementsByClassName("lm-Widget lm-Panel jp-Cell-inputWrapper")[0];a?o(a):requestAnimationFrame(n)};n()})),f=e=>u.ViewPlugin.fromClass(class{constructor(t){this.decorations=this.createLineHighlight(t,e)}createLineHighlight(e,t){const o=new m.RangeSetBuilder,n=e.state.doc.line(t),a=u.Decoration.line({class:"highlight-line"});return o.add(n.from,n.from,a),o.finish()}update(t){t.docChanged&&(this.decorations=this.createLineHighlight(t.view,e))}},{decorations:e=>e.decorations}),v=async(e,t,o,n)=>{var a,i;const l=document.getElementById("extension-button");let s=o;if("audio_index"in e[o])for(;s>0&&"audio_index"in e[s-1]&&e[s-1].audio_index===e[s].audio_index;)s-=1;null===(a=null==n?void 0:n.model)||void 0===a||a.setMetadata("cellIndex",t),null===(i=null==n?void 0:n.model)||void 0===i||i.setMetadata("lineIndex",s),l&&(l.innerHTML=" ▶ ");const d=await r("stop",{method:"POST",body:""});console.log(d)},y={id:"jupyterlab-playback:plugin",description:"A JupyterLab extension.",autoStart:!0,requires:[n.INotebookTracker,a.ISettingRegistry],activate:async(e,t,o)=>{console.log("JupyterLab extension jupyterlab-playback is activated!");const a=await o.load(y.id),s=a.get("metadataEditorWidth").composite,d=a.get("includeMarkdown").composite;t.widgetAdded.connect((async(e,o)=>{var a,y,w,b,M,k;await o.revealed,await o.sessionContext.ready;const E=document.createElement("button");E.id="extension-button";const x=document.createElement("div");if(x.appendChild(E),o.toolbar.insertAfter("spacer","button",new l.Widget({node:x})),null===(a=o.model)||void 0===a?void 0:a.cells)for(let e=0;e<(null===(y=o.model)||void 0===y?void 0:y.cells.length);e++){const t=null===(w=o.model)||void 0===w?void 0:w.cells.get(e);t.getMetadata("id")||t.setMetadata("id",t.id)}const A=null===(b=o.model)||void 0===b?void 0:b.getMetadata("mode");A||null===(M=o.model)||void 0===M||M.setMetadata("mode","editor"),A&&"editor"!==A?"player"===A&&(E.innerHTML=" ▶ ",null===(k=o.model)||void 0===k||k.setMetadata("isPlaying",!1),E.onclick=()=>{var e,t;const a=(null===(e=o.model)||void 0===e?void 0:e.getMetadata("isPlaying"))||!1;null===(t=o.model)||void 0===t||t.setMetadata("isPlaying",!a),a||(async(e,t)=>{var o,a,i,l,s,d,c;const u=null===(o=e.model)||void 0===o?void 0:o.cells,p=(null===(a=e.model)||void 0===a?void 0:a.getMetadata("cellIndex"))||0,g=(null===(i=e.model)||void 0===i?void 0:i.getMetadata("lineIndex"))||0,h=document.getElementById("extension-button");if(u){h?h.innerHTML="||":console.warn("null button");let o=null;for(let a=p;a<u.length;a++){let i="";const s=u.get(a);if("code"===s.type||t&&"markdown"===s.type){const t=s.getMetadata("full_map");for(let d=0;d<(null==t?void 0:t.length);d++){const c=t[d].command,u=t[d].text;if(a===p&&d<g)"code"===s.type&&(i+=u,d!==(null==t?void 0:t.length)-1&&(i+="\n"),s.sharedModel.setSource(i));else{if(!e.model.getMetadata("isPlaying"))return void await v(t,a,d,e);if(c.some((e=>e.includes("AUDIO")))){const e=t[d].audio_src;if(e!==o){o=e;const t=await r("audio",{method:"POST",body:JSON.stringify({audio_src:o})});console.log(t)}}if("markdown"===s.type)for(let o=0;o<[...u].length;o++)if(await new Promise((e=>{setTimeout(e,50)})),!e.model.getMetadata("isPlaying"))return void await v(t,a,d,e);for(const o of c){if(o.startsWith("TYPE")){const o=[...u];d!==(null==t?void 0:t.length)-1&&o.push("\n");for(const n of o)if(i+=n,s.sharedModel.setSource(i),await new Promise((e=>{setTimeout(e,50)})),!e.model.getMetadata("isPlaying"))return void await v(t,a,d,e)}if(o.startsWith("PAUSE")){const e=parseInt(o.replace(/\D/g,""));"code"===s.type&&(i+="\n",s.sharedModel.setSource(i)),await new Promise((t=>{setTimeout(t,e)}))}if(o.startsWith("SELECT")){const t=parseInt(o.replace(/\D/g,"")),n=null===(l=e.content.widgets[a])||void 0===l?void 0:l.editor,i=f(t);n.editor.dispatch({effects:m.StateEffect.appendConfig.of([i])})}o.startsWith("EXECUTE")&&n.NotebookActions.runCells(e.content,[e.content.widgets[a]],e.context.sessionContext)}}}}}}h&&(h.innerHTML=" ▶ "),null===(s=e.model)||void 0===s||s.setMetadata("cellIndex",""),null===(d=e.model)||void 0===d||d.setMetadata("lineIndex",""),null===(c=e.model)||void 0===c||c.setMetadata("isPlaying",!1)})(o,d)}):((async(e,t,o)=>{var n,a;const i=(null===(n=e.model)||void 0===n?void 0:n.cells.length)||0;for(let n=0;n<i;n++){const i=null===(a=e.model)||void 0===a?void 0:a.cells.get(n);if(i&&("code"===i.type||o&&"markdown"===i.type)){await e.content.widgets[n].ready;const o=await h(e,n),a=o.getElementsByClassName("jp-Cell-inputArea")[0];a.classList.add("code-editor"),a.style.width=(100-t).toString()+"%";const l=document.createElement("div");l.classList.add("metadata-editor"),l.style.width=t.toString()+"%";const s=i.getMetadata("map")?p(i.getMetadata("map")):(()=>{const{map:e,doc:t}=g(i.sharedModel.source,i.type);return i.setMetadata("map",e),t})(),d=m.EditorState.create({doc:s,extensions:[c.basicSetup,(0,u.lineNumbers)(),u.EditorView.updateListener.of((e=>{e.docChanged&&i.setMetadata("map",e.state.doc.toString().split("\n").map((e=>({command:e.split("+")}))))}))]});new u.EditorView({state:d,parent:l}),o.appendChild(l)}}})(o,s,d),E.innerHTML="Generate an interactive notebook",E.onclick=async()=>{var e,n;E.innerHTML="Checking syntax...";const{isValid:a,message:l,nbAudioMap:s,nbMap:c}=await(async(e,t)=>{var o;const n=[],a=[],i=[];let l=0,s=!0;const d=null===(o=e.model)||void 0===o?void 0:o.cells;if(d)for(let e=0;e<(null==d?void 0:d.length);e++){const o=[],r=d.get(e);if(r){const i=r.sharedModel.source.split("\n"),d=r.getMetadata("map");if(console.log(i,d),i.length!==d.length){for(n.push(`[Warning] <Cell ${e}>: Line mismatch between code and metadata editors. Review before proceeding, or blank lines will be added for consistency.`);i.length>d.length;)d.push({command:[]});for(;i.length<d.length;)i.push("")}let c=[];i.forEach(((i,u)=>{const m=d[u].command,p={command:m,text:i};if("markdown"===r.type&&m.includes("TYPE")){const t=`[Error] <Cell ${e}, Line ${u} >: TYPE command is not available for markdown cells`;s=!1,console.error(t),n.push(t)}if(m.includes("AUDIO")){if("code"===r.type)if(i.startsWith("#"))c.push(i.slice(2).trim());else{const t=`[Error] <Cell ${e}, Line ${u} >: Bad syntax for AUDIO command in code cells, code line should start with #`;s=!1,console.error(t),n.push(t)}else if(t&&"markdown"===r.type)if(i.startsWith("#")){const t=`[Error] <Cell ${e}, Line ${u} >: Bad syntax for AUDIO command in markdown cells, AUDIO command is not available for markdown headers`;s=!1,console.error(t),n.push(t)}else c.push(i.trim());p.audio_index=l}else if(m.some((e=>e.includes("AUDIOALT")))){const t=m.filter((e=>e.includes("AUDIOALT")))[-1].split("|")[-1];if(t&&"AUDIOALT"!==t)c.push(t);else{const o=`[Error] <Cell ${e}, Line ${u} >: Bad syntax for AUDIOALT command, the command should be followed by | <alt_text>: ${t}`;s=!1,console.error(o),n.push(o)}p.audio_index=l}else!m.includes("AUDIO")&&!m.some((e=>e.includes("AUDIOALT")))&&c.length>0&&(a.push({audiobase:c.join(" "),cellId:r.getMetadata("id")}),l++,c=[]);o.push(p)})),0!==c.length&&(a.push({audiobase:c.join(" "),cellId:r.getMetadata("id")}),l++)}i.push(o)}return{isValid:s,message:n.join("\n"),nbAudioMap:a,nbMap:i}})(o,d);if(a){E.innerHTML="Generating notebook...";const a=await r("load",{method:"POST",body:JSON.stringify({data:null===(e=null==o?void 0:o.model)||void 0===e?void 0:e.toJSON(),relativePath:null===(n=t.currentWidget)||void 0===n?void 0:n.context.path,nbAudioMap:s,nbMap:c})});(0,i.showDialog)({body:a,buttons:[i.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]})}else(0,i.showDialog)({body:l,buttons:[i.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]});E.innerHTML="Regenerate interactive notebook"})}))}},w=y}}]);