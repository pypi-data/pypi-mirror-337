(()=>{var Ie=Object.create;var oe=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var Pe=Object.getPrototypeOf,Le=Object.prototype.hasOwnProperty;var Me=(n,t,e)=>t in n?oe(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var ke=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var Be=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Re(t))!Le.call(n,a)&&a!==e&&oe(n,a,{get:()=>t[a],enumerable:!(r=Ne(t,a))||r.enumerable});return n};var We=(n,t,e)=>(e=n!=null?Ie(Pe(n)):{},Be(t||!n||!n.__esModule?oe(e,"default",{value:n,enumerable:!0}):e,n));var T=(n,t,e)=>Me(n,typeof t!="symbol"?t+"":t,e);var Te=ke((be,z)=>{(function(n,t){"use strict";typeof z=="object"&&typeof z.exports=="object"?z.exports=t():typeof define=="function"&&define.amd?define([],t):n.objectPath=t()})(be,function(){"use strict";var n=Object.prototype.toString;function t(p,c){return p==null?!1:Object.prototype.hasOwnProperty.call(p,c)}function e(p){if(!p||l(p)&&p.length===0)return!0;if(typeof p!="string"){for(var c in p)if(t(p,c))return!1;return!0}return!1}function r(p){return n.call(p)}function a(p){return typeof p=="object"&&r(p)==="[object Object]"}var l=Array.isArray||function(p){return n.call(p)==="[object Array]"};function u(p){return typeof p=="boolean"||r(p)==="[object Boolean]"}function m(p){var c=parseInt(p);return c.toString()===p?c:p}function C(p){p=p||{};var c=function(o){return Object.keys(c).reduce(function(i,s){return s==="create"||typeof c[s]=="function"&&(i[s]=c[s].bind(c,o)),i},{})},A;p.includeInheritedProps?A=function(){return!0}:A=function(o,i){return typeof i=="number"&&Array.isArray(o)||t(o,i)};function V(o,i){if(A(o,i))return o[i]}var N;p.includeInheritedProps?N=function(o,i){typeof i!="string"&&typeof i!="number"&&(i=String(i));var s=V(o,i);if(i==="__proto__"||i==="prototype"||i==="constructor"&&typeof s=="function")throw new Error("For security reasons, object's magic properties cannot be set");return s}:N=function(o,i){return V(o,i)};function R(o,i,s,v){if(typeof i=="number"&&(i=[i]),!i||i.length===0)return o;if(typeof i=="string")return R(o,i.split(".").map(m),s,v);var y=i[0],S=N(o,y);return i.length===1?((S===void 0||!v)&&(o[y]=s),S):(S===void 0&&(typeof i[1]=="number"?o[y]=[]:o[y]={}),R(o[y],i.slice(1),s,v))}return c.has=function(o,i){if(typeof i=="number"?i=[i]:typeof i=="string"&&(i=i.split(".")),!i||i.length===0)return!!o;for(var s=0;s<i.length;s++){var v=m(i[s]);if(typeof v=="number"&&l(o)&&v<o.length||(p.includeInheritedProps?v in Object(o):t(o,v)))o=o[v];else return!1}return!0},c.ensureExists=function(o,i,s){return R(o,i,s,!0)},c.set=function(o,i,s,v){return R(o,i,s,v)},c.insert=function(o,i,s,v){var y=c.get(o,i);v=~~v,l(y)||(y=[],c.set(o,i,y)),y.splice(v,0,s)},c.empty=function(o,i){if(!e(i)&&o!=null){var s,v;if(s=c.get(o,i)){if(typeof s=="string")return c.set(o,i,"");if(u(s))return c.set(o,i,!1);if(typeof s=="number")return c.set(o,i,0);if(l(s))s.length=0;else if(a(s))for(v in s)A(s,v)&&delete s[v];else return c.set(o,i,null)}}},c.push=function(o,i){var s=c.get(o,i);l(s)||(s=[],c.set(o,i,s)),s.push.apply(s,Array.prototype.slice.call(arguments,2))},c.coalesce=function(o,i,s){for(var v,y=0,S=i.length;y<S;y++)if((v=c.get(o,i[y]))!==void 0)return v;return s},c.get=function(o,i,s){if(typeof i=="number"&&(i=[i]),!i||i.length===0)return o;if(o==null)return s;if(typeof i=="string")return c.get(o,i.split("."),s);var v=m(i[0]),y=N(o,v);return y===void 0?s:i.length===1?y:c.get(o[v],i.slice(1),s)},c.del=function(i,s){if(typeof s=="number"&&(s=[s]),i==null||e(s))return i;if(typeof s=="string")return c.del(i,s.split("."));var v=m(s[0]);if(N(i,v),!A(i,v))return i;if(s.length===1)l(i)?i.splice(v,1):delete i[v];else return c.del(i[v],s.slice(1));return i},c}var O=C();return O.create=C,O.withInheritedProps=C({includeInheritedProps:!0}),O})});var he=11;function Ve(n,t){var e=t.attributes,r,a,l,u,m;if(!(t.nodeType===he||n.nodeType===he)){for(var C=e.length-1;C>=0;C--)r=e[C],a=r.name,l=r.namespaceURI,u=r.value,l?(a=r.localName||a,m=n.getAttributeNS(l,a),m!==u&&(r.prefix==="xmlns"&&(a=r.name),n.setAttributeNS(l,a,u))):(m=n.getAttribute(a),m!==u&&n.setAttribute(a,u));for(var O=n.attributes,p=O.length-1;p>=0;p--)r=O[p],a=r.name,l=r.namespaceURI,l?(a=r.localName||a,t.hasAttributeNS(l,a)||n.removeAttributeNS(l,a)):t.hasAttribute(a)||n.removeAttribute(a)}}var J,Fe="http://www.w3.org/1999/xhtml",b=typeof document>"u"?void 0:document,Ge=!!b&&"content"in b.createElement("template"),$e=!!b&&b.createRange&&"createContextualFragment"in b.createRange();function Ke(n){var t=b.createElement("template");return t.innerHTML=n,t.content.childNodes[0]}function Je(n){J||(J=b.createRange(),J.selectNode(b.body));var t=J.createContextualFragment(n);return t.childNodes[0]}function Xe(n){var t=b.createElement("body");return t.innerHTML=n,t.childNodes[0]}function ze(n){return n=n.trim(),Ge?Ke(n):$e?Je(n):Xe(n)}function X(n,t){var e=n.nodeName,r=t.nodeName,a,l;return e===r?!0:(a=e.charCodeAt(0),l=r.charCodeAt(0),a<=90&&l>=97?e===r.toUpperCase():l<=90&&a>=97?r===e.toUpperCase():!1)}function qe(n,t){return!t||t===Fe?b.createElement(n):b.createElementNS(t,n)}function Ye(n,t){for(var e=n.firstChild;e;){var r=e.nextSibling;t.appendChild(e),e=r}return t}function le(n,t,e){n[e]!==t[e]&&(n[e]=t[e],n[e]?n.setAttribute(e,""):n.removeAttribute(e))}var me={OPTION:function(n,t){var e=n.parentNode;if(e){var r=e.nodeName.toUpperCase();r==="OPTGROUP"&&(e=e.parentNode,r=e&&e.nodeName.toUpperCase()),r==="SELECT"&&!e.hasAttribute("multiple")&&(n.hasAttribute("selected")&&!t.selected&&(n.setAttribute("selected","selected"),n.removeAttribute("selected")),e.selectedIndex=-1)}le(n,t,"selected")},INPUT:function(n,t){le(n,t,"checked"),le(n,t,"disabled"),n.value!==t.value&&(n.value=t.value),t.hasAttribute("value")||n.removeAttribute("value")},TEXTAREA:function(n,t){var e=t.value;n.value!==e&&(n.value=e);var r=n.firstChild;if(r){var a=r.nodeValue;if(a==e||!e&&a==n.placeholder)return;r.nodeValue=e}},SELECT:function(n,t){if(!t.hasAttribute("multiple")){for(var e=-1,r=0,a=n.firstChild,l,u;a;)if(u=a.nodeName&&a.nodeName.toUpperCase(),u==="OPTGROUP")l=a,a=l.firstChild;else{if(u==="OPTION"){if(a.hasAttribute("selected")){e=r;break}r++}a=a.nextSibling,!a&&l&&(a=l.nextSibling,l=null)}n.selectedIndex=e}}},M=1,Ee=11,ye=3,xe=8;function D(){}function Qe(n){if(n)return n.getAttribute&&n.getAttribute("id")||n.id}function Ze(n){return function(e,r,a){if(a||(a={}),typeof r=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var l=r;r=b.createElement("html"),r.innerHTML=l}else r=ze(r);else r.nodeType===Ee&&(r=r.firstElementChild);var u=a.getNodeKey||Qe,m=a.onBeforeNodeAdded||D,C=a.onNodeAdded||D,O=a.onBeforeElUpdated||D,p=a.onElUpdated||D,c=a.onBeforeNodeDiscarded||D,A=a.onNodeDiscarded||D,V=a.onBeforeElChildrenUpdated||D,N=a.skipFromChildren||D,R=a.addChild||function(f,d){return f.appendChild(d)},o=a.childrenOnly===!0,i=Object.create(null),s=[];function v(f){s.push(f)}function y(f,d){if(f.nodeType===M)for(var E=f.firstChild;E;){var g=void 0;d&&(g=u(E))?v(g):(A(E),E.firstChild&&y(E,d)),E=E.nextSibling}}function S(f,d,E){c(f)!==!1&&(d&&d.removeChild(f),A(f),y(f,E))}function ne(f){if(f.nodeType===M||f.nodeType===Ee)for(var d=f.firstChild;d;){var E=u(d);E&&(i[E]=d),ne(d),d=d.nextSibling}}ne(e);function re(f){C(f);for(var d=f.firstChild;d;){var E=d.nextSibling,g=u(d);if(g){var h=i[g];h&&X(d,h)?(d.parentNode.replaceChild(h,d),F(h,d)):re(d)}else re(d);d=E}}function Ue(f,d,E){for(;d;){var g=d.nextSibling;(E=u(d))?v(E):S(d,f,!0),d=g}}function F(f,d,E){var g=u(d);if(g&&delete i[g],!E){var h=O(f,d);if(h===!1||(h instanceof HTMLElement&&(f=h,ne(f)),n(f,d),p(f),V(f,d)===!1))return}f.nodeName!=="TEXTAREA"?He(f,d):me.TEXTAREA(f,d)}function He(f,d){var E=N(f,d),g=d.firstChild,h=f.firstChild,P,_,L,$,U;e:for(;g;){for($=g.nextSibling,P=u(g);!E&&h;){if(L=h.nextSibling,g.isSameNode&&g.isSameNode(h)){g=$,h=L;continue e}_=u(h);var K=h.nodeType,H=void 0;if(K===g.nodeType&&(K===M?(P?P!==_&&((U=i[P])?L===U?H=!1:(f.insertBefore(U,h),_?v(_):S(h,f,!0),h=U,_=u(h)):H=!1):_&&(H=!1),H=H!==!1&&X(h,g),H&&F(h,g)):(K===ye||K==xe)&&(H=!0,h.nodeValue!==g.nodeValue&&(h.nodeValue=g.nodeValue))),H){g=$,h=L;continue e}_?v(_):S(h,f,!0),h=L}if(P&&(U=i[P])&&X(U,g))E||R(f,U),F(U,g);else{var se=m(g);se!==!1&&(se&&(g=se),g.actualize&&(g=g.actualize(f.ownerDocument||b)),R(f,g),re(g))}g=$,h=L}Ue(f,h,_);var ge=me[f.nodeName];ge&&ge(f,d)}var x=e,G=x.nodeType,pe=r.nodeType;if(!o){if(G===M)pe===M?X(e,r)||(A(e),x=Ye(e,qe(r.nodeName,r.namespaceURI))):x=r;else if(G===ye||G===xe){if(pe===G)return x.nodeValue!==r.nodeValue&&(x.nodeValue=r.nodeValue),x;x=r}}if(x===r)A(e);else{if(r.isSameNode&&r.isSameNode(x))return;if(F(x,r,o),s)for(var ie=0,De=s.length;ie<De;ie++){var ae=i[s[ie]];ae&&S(ae,ae.parentNode,!1)}}return!o&&x!==e&&e.parentNode&&(x.actualize&&(x=x.actualize(e.ownerDocument||b)),e.parentNode.replaceChild(x,e)),x}}var je=Ze(Ve),we=je;var Se=We(Te());function q(n){var t,e,r;return JSON.stringify([n.context_id,n.handler_name,(t=n.options.debounce)!=null?t:null,(e=n.options.prevent_default)!=null?e:null,(r=n.options.throttle)!=null?r:null,...Object.entries(n.param_map).sort((a,l)=>a[0].localeCompare(l[0]))])}var Y=class{constructor(t,e){T(this,"descriptor");T(this,"lastCall");T(this,"timeoutHandle");T(this,"nextEvent");T(this,"updater");T(this,"handler",t=>this.handle(t));this.descriptor=e,this.updater=()=>t(this)}get id(){return q(this.descriptor)}popEvent(){this.timeoutHandle&&clearTimeout(this.timeoutHandle);let t=this.nextEvent;return this.nextEvent&&(this.lastCall=new Date().getTime(),this.nextEvent=void 0),t}handle(t){let e={$handler_name:this.descriptor.handler_name};for(let l of Object.keys(this.descriptor.param_map)){let u=this.descriptor.param_map[l];e[l]=Se.default.withInheritedProps.get(t,u)}this.nextEvent={context_id:this.descriptor.context_id,data:e},this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=void 0),this.descriptor.options.prevent_default&&t.preventDefault();let r=[];if(this.descriptor.options.debounce&&r.push(this.descriptor.options.debounce),this.descriptor.options.throttle&&this.lastCall){let l=new Date().getTime();r.push(this.descriptor.options.throttle+this.lastCall-l)}let a=Math.max(0,...r);a===0?this.updater():this.timeoutHandle=setTimeout(this.updater,a)}},Ae="rxxxt-on-",Q=class{constructor(t){T(this,"updater");T(this,"nodeHandlers",new WeakMap);this.updater=t}apply(t){for(let e of t.getElementsByTagName("*"))this.applyElement(e)}applyElement(t){var l;let e=new Map(Object.entries((l=this.nodeHandlers.get(t))!=null?l:{})),r=this.getEventDescriptors(t),a={};for(let u of e.keys()){let m=e.get(u);r.has(u)&&q(r.get(u))==m.id?(r.delete(u),a[u]=m):t.removeEventListener(u,m.handler)}for(let u of r.entries()){let m=new Y(this.updater,u[1]);t.addEventListener(u[0],m.handler),a[u[0]]=m}this.nodeHandlers.set(t,a)}getEventDescriptors(t){var r;let e=new Map;for(let a of t.getAttributeNames())if(a.startsWith(Ae)){let l=a.substring(Ae.length),u=JSON.parse(atob((r=t.getAttribute(a))!=null?r:""));e.set(l,u)}return e}},Z=class{constructor(t){T(this,"contextEvents",new Map);T(this,"updater");this.updater=t}registerEvent(t,e,r){var u;let a=(u=this.contextEvents.get(r.context_id))!=null?u:[];if(a.some(m=>m.target.deref()==t&&m.name==e&&m.handler.id==q(r)))return;let l=new Y(this.updater,r);t.addEventListener(e,l.handler),a.push({target:new WeakRef(t),name:e,handler:l}),this.contextEvents.set(r.context_id,a)}unregisterEvent(t,e,r){var l;let a=[];for(let u of(l=this.contextEvents.get(r.context_id))!=null?l:[])u.target.deref()==t&&u.name==e&&u.handler.id==q(r)?this.removeEventHandler(u):a.push(u);a.length==0?this.contextEvents.delete(r.context_id):this.contextEvents.set(r.context_id,a)}clean(t){var e;for(let r of t){let a=(e=this.contextEvents.get(r))!=null?e:[];this.contextEvents.delete(r),a.forEach(this.removeEventHandler)}}removeEventHandler(t){let e=t.target.deref();e!==void 0&&e.removeEventListener(t.name,t.handler.handler)}};var I,B="",et=!1,W,w,tt="root",ue=new Set,ee=!1,k=0,Ce=n=>{ue.add(n),de()},nt=new Q(Ce),j=new Z(Ce),ce=()=>{k++,ee=!1},fe=()=>{k=Math.max(0,k-1),k==0&&ee&&W()},_e=()=>{let n=[];for(let t of ue){let e=t.popEvent();e!==void 0&&n.push(e)}return ue.clear(),n},te=n=>{var t;for(let e of n)if(e.event==="navigate"){let r=new URL(e.location,location.href);I===void 0||I.origin!==r.origin||!r.pathname.startsWith(I.pathname)?location.assign(r):window.history.pushState({},"",e.location)}else if(e.event==="use-websocket")e.websocket?rt():w==null||w.close();else if(e.event==="set-cookie"){let r=["".concat(e.name,"=").concat((t=e.value)!=null?t:"")];typeof e.path=="string"&&r.push("path=".concat(e.path)),typeof e.expires=="string"&&r.push("expires=".concat(new Date(e.expires).toUTCString())),typeof e.max_age=="number"&&r.push("max-age=".concat(e.max_age)),typeof e.domain=="string"&&r.push("domain=".concat(e.domain)),e.secure&&r.push("secure"),e.http_only&&r.push("httponly"),document.cookie=r.join(";")}else if(e.event==="event-modify-window")e.mode==="add"?j.registerEvent(window,e.name,e.descriptor):e.mode==="remove"&&j.unregisterEvent(window,e.name,e.descriptor);else if(e.event==="event-modify-query-selector"){let r=[];if(e.all)r.push(...document.querySelectorAll(e.selector));else{let a=document.querySelector(e.selector);a!==null&&r.push(a)}for(let a of r)e.mode==="add"?j.registerEvent(a,e.name,e.descriptor):e.mode==="remove"&&j.unregisterEvent(a,e.name,e.descriptor)}},ve=n=>{let t;if(n===void 0){let e=document.getElementById(tt);if(e===null)throw new Error("Update target not found!");t=e}else{let e=document.createElement("div");e.innerHTML=n;let r=e.children.item(0);if(r===null||r.tagName!=="rxxxt-meta".toUpperCase())throw new Error("Invalid update root!");let a=document.getElementById(r.id);if(a===null)throw new Error("Update target not found!");t=a,we(t,r)}nt.apply(t)},rt=()=>{if(w)return;ce();let n=new URL(location.href);n.protocol=location.protocol=="https:"?"wss":"ws",w=new WebSocket(n),w.addEventListener("close",()=>{W=Oe,w=void 0}),w.addEventListener("open",()=>{W=it,w==null||w.send(JSON.stringify({type:"init",state_token:B,enable_state_updates:et})),fe()}),w.addEventListener("message",t=>{if(typeof t.data!="string")return;let e=JSON.parse(t.data);for(let r of e.html_parts)ve(r);e.state_token&&(B=e.state_token),te(e.events),fe()})},it=async()=>{ce(),w==null||w.send(JSON.stringify({type:"update",events:_e(),location:location.href.substring(location.origin.length)}))},Oe=async()=>{ce();let n=JSON.stringify({state_token:B,events:_e()}),t=await fetch(location.href,{method:"POST",body:n,headers:{"Content-Type":"application/json"},credentials:"include"}).then(e=>e.json());for(let e of t.html_parts)ve(e);B=t.state_token,te(t.events),fe()};W=Oe;var de=()=>{ee||(ee=!0,setTimeout(()=>{k==0&&W()},0))};window.rxxxt={navigate:n=>{te([{event:"navigate",location:new URL(n,location.href).href}]),de()},init:n=>{I=new URL(location.href),I.pathname.endsWith(n.path)?I.pathname=I.pathname.slice(0,I.pathname.length-n.path.length):console.warn("Invalid base url!"),window.addEventListener("popstate",de),B=n.state_token,te(n.events),ve()}};})();
