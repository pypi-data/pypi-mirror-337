<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>advertools.logs &mdash;  Python</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=81998473"></script>
        <script src="../../_static/doctools.js?v=9bcbadda"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
        <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
        <script async="async" src="https://unpkg.com/thebe@0.8.2/lib/index.js"></script>
        <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            advertools
          </a>
              <div class="version">
                0.16.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">About advertools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.survey.html">Survey - your feedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.cli.cli.html">Command Line Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SEM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.kw_generate.html">Generate SEM Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.ad_create.html">Create Text Ads on a Large Scale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.ad_from_string.html">Create Text Ads From Description Text</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SEO</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.robotstxt.html">robots.txt</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.sitemaps.html">XML Sitemaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.spider.html">SEO Spider / Crawler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.code_recipes.spider_strategies.html">Crawl Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.crawlytics.html">Crawl Analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.header_spider.html">Crawl headers (HEAD method only)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.image_spider.html">Crawl images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.logs.html">Python Log File Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.logs.html#parse-and-analyze-crawl-logs-in-a-dataframe">Parse and Analyze Crawl Logs in a Dataframe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.reverse_dns_lookup.html">Reverse DNS Lookup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.serp.html">Analyze Search Engine Results (SERPs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.knowledge_graph.html">Google's Knowledge Graph</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Text &amp; Content Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.urlytics.html">URL Structure Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.emoji.html">Emoji Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.extract.html">Extract Structured Entities from Text</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.stopwords.html">Stop Words</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.word_frequency.html">Text Analysis (absolute &amp; weighted word frequency)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.word_tokenize.html">Word Tokenization (N-grams)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Social Media</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.twitter.html">Twitter Data API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advertools.youtube.html">YouTube Data API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Index &amp; Change Log</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../include_changelog.html">Index &amp; Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">advertools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">advertools.logs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for advertools.logs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. _logs:</span>

<span class="sd">Python Log File Analysis</span>
<span class="sd">========================</span>

<span class="sd">Logs contain very detailed information about events happening on computers.</span>
<span class="sd">And the extra details that they provide come with additional complexity that</span>
<span class="sd">we need to handle ourselves. A pageview may contain many log lines, and a</span>
<span class="sd">session can consist of several pageviews for example.</span>

<span class="sd">Another important characterisitic of log files is that their are usualy not</span>
<span class="sd">big.</span>
<span class="sd">They are massive.</span>

<span class="sd">So, we also need to cater for their large size, as well as rapid changes.</span>

<span class="sd">TL;DR</span>

<span class="sd">&gt;&gt;&gt; import advertools as adv</span>
<span class="sd">&gt;&gt;&gt; import pandas as pd</span>
<span class="sd">&gt;&gt;&gt; adv.logs_to_df(</span>
<span class="sd">...     log_file=&quot;access.log&quot;,</span>
<span class="sd">...     output_file=&quot;access_logs.parquet&quot;,</span>
<span class="sd">...     errors_file=&quot;log_errors.csv&quot;,</span>
<span class="sd">...     log_format=&quot;common&quot;,</span>
<span class="sd">...     fields=None,</span>
<span class="sd">... )</span>
<span class="sd">&gt;&gt;&gt; logs_df = pd.read_parquet(&quot;access_logs.parquet&quot;)</span>

<span class="sd">How to run the :func:`logs_to_df` function:</span>
<span class="sd">-------------------------------------------</span>

<span class="sd">* ``log_file``: The path to the log file you are trying to analyze.</span>
<span class="sd">* ``output_file``: The path to where you want the parsed and compressed file</span>
<span class="sd">  to be saved. Only the `parquet` format is supported.</span>
<span class="sd">* ``errors_file``: You will almost certainly have log lines that don&#39;t conform</span>
<span class="sd">  to the format that you have, so all lines that weren&#39;t properly parsed would</span>
<span class="sd">  go to this file. This file also contains the error messages, so you know what</span>
<span class="sd">  went wrong, and how you might fix it. In some cases, you might simply take</span>
<span class="sd">  these &quot;errors&quot; and parse them again. They might not be really errors, but</span>
<span class="sd">  lines in a different format, or temporary debug messages.</span>
<span class="sd">* ``log_format``: The format in which your logs were formatted. Logs can (and</span>
<span class="sd">  are) formatted in many ways, and there is no right or wrong way. However,</span>
<span class="sd">  there are defaults, and a few popular formats that most servers use. It is</span>
<span class="sd">  likely that your file is in one of the popular formats. This parameter can</span>
<span class="sd">  take any one of the pre-defined formats, for example &quot;common&quot;, or &quot;combined&quot;,</span>
<span class="sd">  or a regular expression that you provide. This means that **you can parse any</span>
<span class="sd">  log format** (as long as lines are single lines, and not formatted in JSON).</span>
<span class="sd">* ``date_format``: The date format string that the log file uses. For the supported</span>
<span class="sd">  default formats there are also default date formats. In some cases you might have a</span>
<span class="sd">  different date format. You can use standard</span>
<span class="sd">  `Python date string formatting. &lt;https://strftime.org/&gt;`_. For example, to parse this</span>
<span class="sd">  string &quot;2024-01-01&quot; you can use ``%Y-%m-%d``. If this is the correct pattern the</span>
<span class="sd">  output file&#39;s datetime column will be saved as a datetime column, otherwise, it will</span>
<span class="sd">  be saved as a string.</span>
<span class="sd">* ``fields``: If you selected one of the supported formats, then there is no</span>
<span class="sd">  need to provide a value for this parameter. You have to provide a list of</span>
<span class="sd">  fields in case you provide a custom (regex) format. The fields will become</span>
<span class="sd">  the names of the columns of the resulting DataFrame, so you can distinguish</span>
<span class="sd">  between them (client, time, status code, response size, etc.)</span>

<span class="sd">Supported Log Formats</span>
<span class="sd">---------------------</span>

<span class="sd">* `common`</span>
<span class="sd">* `combined` (a.k.a &quot;extended&quot;)</span>
<span class="sd">* `common_with_vhost`</span>
<span class="sd">* `nginx_error`</span>
<span class="sd">* `apache_error`</span>


<span class="sd">Log File Analysis - Data Preparation</span>
<span class="sd">------------------------------------</span>

<span class="sd">We go through an example where we prepare the data for analysis, and here is</span>
<span class="sd">the plan:</span>

<span class="sd">1. Parse the log file into a DataFrame saved to disk with a `.parquet`</span>
<span class="sd">   extension. A side effect is that your log file is also compressed down to</span>
<span class="sd">   5% - 15% of its original size. It also makes it super efficient to query and</span>
<span class="sd">   analyze once in this format. Function used: ``logs_to_df``.</span>
<span class="sd">2. Convert data types as needed (optional): Most importantly converting the</span>
<span class="sd">   `datetime` column into a date object helps a lot in querying the data. Other</span>
<span class="sd">   possibilities include converting to categorical data types for more</span>
<span class="sd">   efficient storage and querying. Function used: ``pandas.to_datetime``.</span>
<span class="sd">3. Get the hostnames of the IP addresses of the clients sending requests.</span>
<span class="sd">   Function used:  :ref:`reverse_dns_lookup &lt;reverse_dns_lookup&gt;`. We can then</span>
<span class="sd">   easily add a ``hostname`` column to the original DataFrame.</span>
<span class="sd">4. Parse and split URL columns into their respective components. Typically we</span>
<span class="sd">   have ``request`` which is the resource/URL requested, as well as ``referer``</span>
<span class="sd">   , which shows us where the request was referred from. Function used:</span>
<span class="sd">   :ref:`url_to_df &lt;urlytics&gt;`.</span>
<span class="sd">5. Parse user agents if available. This allows us to analyze by user-agent</span>
<span class="sd">   family, operating system, bot/non-bot, version, and any other combination we</span>
<span class="sd">   want.</span>
<span class="sd">6. Combine all data together, and save back to a new `.parquet` file, and start</span>
<span class="sd">   analyzing.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    !head data/sample_log.log</span>

<span class="sd">.. code-block::</span>

<span class="sd">    66.249.73.72 - - [16/Feb/2022:00:18:53 +0000] &quot;GET / HTTP/1.1&quot; 200 1095 &quot;-&quot; &quot;Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.80 Mobile Safari/537.36 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span>
<span class="sd">    109.237.103.118 - - [16/Feb/2022:00:20:39 +0000] &quot;GET /.env HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36&quot;</span>
<span class="sd">    45.12.223.214 - - [16/Feb/2022:00:23:45 +0000] &quot;GET / HTTP/1.0&quot; 200 2240 &quot;http://adver.tools/&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36&quot;</span>
<span class="sd">    51.68.77.249 - - [16/Feb/2022:00:26:23 +0000] &quot;GET /robots.txt HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;advertools/0.13.0&quot;</span>
<span class="sd">    51.68.77.249 - - [16/Feb/2022:00:26:23 +0000] &quot;HEAD / HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;advertools/0.13.0&quot;</span>
<span class="sd">    192.241.211.176 - - [16/Feb/2022:00:31:16 +0000] &quot;GET /login HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 zgrab/0.x&quot;</span>
<span class="sd">    66.249.73.69 - - [16/Feb/2022:00:48:56 +0000] &quot;GET /robots.txt HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span>
<span class="sd">    66.249.73.72 - - [16/Feb/2022:00:48:56 +0000] &quot;GET /staging/urlytics/ HTTP/1.1&quot; 200 520 &quot;-&quot; &quot;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span>
<span class="sd">    66.249.73.75 - - [16/Feb/2022:00:49:38 +0000] &quot;GET /staging/urlytics/_dash-component-suites/dash/html/dash_html_components.v2_0_0m1638886228.min.js HTTP/1.1&quot; 200 154258 &quot;http://www.adver.tools/staging/urlytics/&quot; &quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Chrome/98.0.4758.80 Safari/537.36&quot;</span>
<span class="sd">    66.249.73.75 - - [16/Feb/2022:00:49:39 +0000] &quot;GET /staging/urlytics/_dash-layout HTTP/1.1&quot; 200 2547 &quot;http://www.adver.tools/staging/urlytics/&quot; &quot;Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Chrome/98.0.4758.80 Safari/537.36&quot;</span>


<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    import advertools as adv</span>
<span class="sd">    import pandas as pd</span>
<span class="sd">    from ua_parser import user_agent_parser</span>
<span class="sd">    pd.options.display.max_columns = None</span>

<span class="sd">    adv.logs_to_df(log_file=&#39;data/sample_log.log&#39;,</span>
<span class="sd">                   output_file=&#39;data/adv_logs.parquet&#39;,</span>
<span class="sd">                   errors_file=&#39;data/adv_errors.txt&#39;,</span>
<span class="sd">                   log_format=&#39;combined&#39;)</span>

<span class="sd">Read the parquet file into a pandas DataFrame, and convert the ``datetime``</span>
<span class="sd">column into a datetime object.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    logs_df = pd.read_parquet(&#39;data/adv_logs.parquet&#39;)</span>
<span class="sd">    logs_df[&#39;datetime&#39;] = pd.to_datetime(logs_df[&#39;datetime&#39;],</span>
<span class="sd">                                         format=&#39;%d/%b/%Y:%H:%M:%S %z&#39;)</span>

<span class="sd">    logs_df</span>


<span class="sd">Perform a reverse DNS lookup on the IP addresses in the ``client`` column:</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    %%time</span>
<span class="sd">    host_df = adv.reverse_dns_lookup(logs_df[&#39;client&#39;])</span>
<span class="sd">    print(f&#39;Rows, columns: {host_df.shape}&#39;)</span>
<span class="sd">    host_df.head(15)</span>
<span class="sd">    # Rows, columns: (1210, 9)</span>
<span class="sd">    # CPU times: user 745 ms, sys: 729 ms, total: 1.47 s</span>
<span class="sd">    # Wall time: 21.1 s</span>

<span class="sd">====  ===============  =======  ===========  ==========  ==========  ======================================  ===========================  ==============  ======================</span>
<span class="sd">  ..  ip_address         count    cum_count        perc    cum_perc  hostname                                aliaslist                    ipaddrlist      errors</span>
<span class="sd">====  ===============  =======  ===========  ==========  ==========  ======================================  ===========================  ==============  ======================</span>
<span class="sd">   0  143.244.132.225      426          426  0.0701004    0.0701004                                                                                       [Errno 1] Unknown host</span>
<span class="sd">   1  45.146.164.110       290          716  0.0477209    0.117821                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   2  46.177.196.171       192          908  0.0315945    0.149416   ppp046177196171.access.hol.gr           171.196.177.46.in-addr.arpa  46.177.196.171</span>
<span class="sd">   3  185.22.173.83        182         1090  0.029949     0.179365                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   4  152.32.226.223       171         1261  0.0281389    0.207504                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   5  94.200.35.174        154         1415  0.0253415    0.232845                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   6  89.47.44.105         130         1545  0.0213921    0.254237   ppp089047044105.access.hol.gr           105.44.47.89.in-addr.arpa    89.47.44.105</span>
<span class="sd">   7  94.200.92.2          119         1664  0.019582     0.273819                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   8  143.244.132.234      113         1777  0.0185947    0.292414                                                                                        [Errno 1] Unknown host</span>
<span class="sd">   9  217.100.98.101        81         1858  0.0133289    0.305743   d9646265.static.ziggozakelijk.nl        101.98.100.217.in-addr.arpa  217.100.98.101</span>
<span class="sd">  10  203.163.243.241       79         1937  0.0129998    0.318743                                                                                        [Errno 1] Unknown host</span>
<span class="sd">  11  66.249.73.135         77         2014  0.0126707    0.331414   crawl-66-249-73-135.googlebot.com       135.73.249.66.in-addr.arpa   66.249.73.135</span>
<span class="sd">  12  194.163.179.92        60         2074  0.00987329   0.341287   vmi660635.contaboserver.net             92.179.163.194.in-addr.arpa  194.163.179.92</span>
<span class="sd">  13  66.249.73.137         58         2132  0.00954418   0.350831   crawl-66-249-73-137.googlebot.com       137.73.249.66.in-addr.arpa   66.249.73.137</span>
<span class="sd">  14  109.70.100.30         58         2190  0.00954418   0.360375   tor-exit-anonymizer.appliedprivacy.net  30.100.70.109.in-addr.arpa   109.70.100.30</span>
<span class="sd">====  ===============  =======  ===========  ==========  ==========  ======================================  ===========================  ==============  ======================</span>

<span class="sd">Add a new ``hostname`` column, by matching IP adresses to their hostnames.</span>


<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    ip_host_dict = dict(zip(host_df[&#39;ip_address&#39;], host_df[&#39;hostname&#39;]))</span>
<span class="sd">    logs_df[&#39;hostname&#39;] = [ip_host_dict[ip] for ip in logs_df[&#39;client&#39;]]</span>

<span class="sd">Split the request URLs into their components.</span>


<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    request_url_df = adv.url_to_df(logs_df[&#39;request&#39;])</span>
<span class="sd">    request_url_df = request_url_df.add_prefix(&#39;request_&#39;)</span>
<span class="sd">    request_url_df.head(10)</span>


<span class="sd">====  ================================================================================================  ================  ================  ================================================================================================  ===============  ==================  ==================  ==============  ===============  ===============  ======================  ===============  ===============  =============================================  ===============  ===============  ===============  ================  ================  ================  ================  =============================================  =====================  =================  ====================================  ========================  =======================  =========================  ====================  ===================  =================  =======================  ==================  ======================  ========================  ===================  ===================  ====================  ===================  ====================  ======================  =========================  ==========================  ==================================  ====================  =========================  =======================  ====================  ==================  ===================  =====================  ====================  ====================  ===================  =========================  ==================  ==========================  =================  ===========================  =====================  ====================  =======================  ==================  =====================  =====================  ======================  ==========================  ========================  =========================  ======================  =====================================================  =========================  =====================================  ====================  ======================  ==========================  =====================  =====================  ====================  ======================  =======================  =================  ======================  =================  =====================  ===================  ====================  ====================  =======================  ===================  ========================  =====================  ====================  ===================  ===================  ===================  =======================  =====================  ======================  ===================  =================================  ====================  ========================  ========================</span>
<span class="sd">  ..  request_url                                                                                       request_scheme    request_netloc    request_path                                                                                      request_query    request_fragment      request_hostname    request_port  request_dir_1    request_dir_2    request_dir_3           request_dir_4    request_dir_5    request_dir_6                                    request_dir_7    request_dir_8    request_dir_9    request_dir_10    request_dir_11    request_dir_12    request_dir_13  request_last_dir                                 request_query_index    request_query_s    request_query_XDEBUG_SESSION_START    request_query_function    request_query_vars[0]    request_query_vars[1][]    request_query_file    request_query_url    request_query_a    request_query_content    request_query_wt    request_query_action    request_query_username    request_query_psd    request_query_dns    request_query_step    request_query_cmd    request_query_lang    request_query_option    request_query_folderIds    request_query_input_file    request_query_currentsetting.htm    request_query_type    request_query_next_file    request_query_curpath    request_query_page    request_query_id    request_query_img    request_query_panel    request_query_todo    request_query_code    request_query_ref    request_query_scopeName    request_query_op    request_query_controller    request_query_q    request_query_sb_category    request_query_Email    request_query_name    request_query_abspath    request_query_fn    request_query_files    request_query_thumb    request_query_ACTION    request_query_NOCONTINUE    request_query_filepath    request_query_file_link    request_query_myPath    request_query_adaptive-images-settings[source_file]    request_query_aam-media    request_query_cpabc_calendar_update    request_query_term    request_query_Itemid    request_query_search_key    request_query_short    request_query_title    request_query_Type    request_query_format    request_query_findcli    request_query_v    request_query_target    request_query__    request_query_albid    request_query_pic    request_query_path    request_query_mode    request_query_libpath    request_query_srt    request_query_redirect    request_query_order    request_query_item    request_query_gid    request_query_act    request_query_rid    request_query_service    request_query_agent    request_query_typeid    request_query_dir    request_query_stockCodeInternal    request_query_site    request_query_position    request_query_fileName</span>
<span class="sd">====  ================================================================================================  ================  ================  ================================================================================================  ===============  ==================  ==================  ==============  ===============  ===============  ======================  ===============  ===============  =============================================  ===============  ===============  ===============  ================  ================  ================  ================  =============================================  =====================  =================  ====================================  ========================  =======================  =========================  ====================  ===================  =================  =======================  ==================  ======================  ========================  ===================  ===================  ====================  ===================  ====================  ======================  =========================  ==========================  ==================================  ====================  =========================  =======================  ====================  ==================  ===================  =====================  ====================  ====================  ===================  =========================  ==================  ==========================  =================  ===========================  =====================  ====================  =======================  ==================  =====================  =====================  ======================  ==========================  ========================  =========================  ======================  =====================================================  =========================  =====================================  ====================  ======================  ==========================  =====================  =====================  ====================  ======================  =======================  =================  ======================  =================  =====================  ===================  ====================  ====================  =======================  ===================  ========================  =====================  ====================  ===================  ===================  ===================  =======================  =====================  ======================  ===================  =================================  ====================  ========================  ========================</span>
<span class="sd">   0  /                                                                                                                                     /                                                                                                                                                     nan             nan  nan              nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  nan                                                              nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   1  /.env                                                                                                                                 /.env                                                                                                                                                 nan             nan  .env             nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  .env                                                             nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   2  /                                                                                                                                     /                                                                                                                                                     nan             nan  nan              nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  nan                                                              nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   3  /robots.txt                                                                                                                           /robots.txt                                                                                                                                           nan             nan  robots.txt       nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  robots.txt                                                       nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   4  /                                                                                                                                     /                                                                                                                                                     nan             nan  nan              nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  nan                                                              nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   5  /login                                                                                                                                /login                                                                                                                                                nan             nan  login            nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  login                                                            nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   6  /robots.txt                                                                                                                           /robots.txt                                                                                                                                           nan             nan  robots.txt       nan              nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  robots.txt                                                       nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   7  /staging/urlytics/                                                                                                                    /staging/urlytics/                                                                                                                                    nan             nan  staging          urlytics         nan                     nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  urlytics                                                         nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   8  /staging/urlytics/_dash-component-suites/dash/html/dash_html_components.v2_0_0m1638886228.min.js                                      /staging/urlytics/_dash-component-suites/dash/html/dash_html_components.v2_0_0m1638886228.min.js                                                      nan             nan  staging          urlytics         _dash-component-suites  dash             html             dash_html_components.v2_0_0m1638886228.min.js              nan              nan              nan               nan               nan               nan               nan  dash_html_components.v2_0_0m1638886228.min.js                    nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">   9  /staging/urlytics/_dash-layout                                                                                                        /staging/urlytics/_dash-layout                                                                                                                        nan             nan  staging          urlytics         _dash-layout            nan              nan              nan                                                        nan              nan              nan               nan               nan               nan               nan  _dash-layout                                                     nan                nan                                   nan                       nan                      nan                        nan                   nan                  nan                nan                      nan                 nan                     nan                       nan                  nan                  nan                   nan                  nan                   nan                     nan                        nan                         nan                                 nan                   nan                        nan                      nan                   nan                 nan                  nan                    nan                   nan                   nan                  nan                        nan                 nan                         nan                nan                          nan                    nan                   nan                      nan                 nan                    nan                    nan                     nan                         nan                       nan                        nan                     nan                                                    nan                        nan                                    nan                   nan                     nan                         nan                    nan                    nan                   nan                     nan                      nan                nan                     nan                nan                    nan                  nan                   nan                   nan                      nan                  nan                       nan                    nan                   nan                  nan                  nan                  nan                      nan                    nan                     nan                  nan                                nan                   nan                       nan                       nan</span>
<span class="sd">====  ================================================================================================  ================  ================  ================================================================================================  ===============  ==================  ==================  ==============  ===============  ===============  ======================  ===============  ===============  =============================================  ===============  ===============  ===============  ================  ================  ================  ================  =============================================  =====================  =================  ====================================  ========================  =======================  =========================  ====================  ===================  =================  =======================  ==================  ======================  ========================  ===================  ===================  ====================  ===================  ====================  ======================  =========================  ==========================  ==================================  ====================  =========================  =======================  ====================  ==================  ===================  =====================  ====================  ====================  ===================  =========================  ==================  ==========================  =================  ===========================  =====================  ====================  =======================  ==================  =====================  =====================  ======================  ==========================  ========================  =========================  ======================  =====================================================  =========================  =====================================  ====================  ======================  ==========================  =====================  =====================  ====================  ======================  =======================  =================  ======================  =================  =====================  ===================  ====================  ====================  =======================  ===================  ========================  =====================  ====================  ===================  ===================  ===================  =======================  =====================  ======================  ===================  =================================  ====================  ========================  ========================</span>

<span class="sd">Do the same for the URLs in the ``referer`` column.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    referer_url_df = adv.url_to_df(logs_df[&#39;referer&#39;])</span>
<span class="sd">    referer_url_df = referer_url_df.add_prefix(&#39;referer_&#39;)</span>
<span class="sd">    referer_url_df.head(10)</span>

<span class="sd">====  ========================================  ================  ================  ==================  ===============  ==================  ===============  ===============  ==================  ==================  ==============  ===============</span>
<span class="sd">  ..  referer_url                               referer_scheme    referer_netloc    referer_path        referer_query    referer_fragment    referer_dir_1    referer_dir_2    referer_last_dir    referer_hostname      referer_port  referer_dir_3</span>
<span class="sd">====  ========================================  ================  ================  ==================  ===============  ==================  ===============  ===============  ==================  ==================  ==============  ===============</span>
<span class="sd">   0  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   1  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   2  http://adver.tools/                       http              adver.tools       /                                                                                                                                             nan</span>
<span class="sd">   3  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   4  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   5  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   6  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   7  –                                                                             –                                                        –                                 –                                                  nan</span>
<span class="sd">   8  http://www.adver.tools/staging/urlytics/  http              www.adver.tools   /staging/urlytics/                                       staging          urlytics         urlytics                                           nan</span>
<span class="sd">   9  http://www.adver.tools/staging/urlytics/  http              www.adver.tools   /staging/urlytics/                                       staging          urlytics         urlytics                                           nan</span>
<span class="sd">====  ========================================  ================  ================  ==================  ===============  ==================  ===============  ===============  ==================  ==================  ==============  ===============</span>
<span class="sd">Parse the ``user_agent`` column.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    ua_df = pd.json_normalize([user_agent_parser.Parse(ua) for ua in logs_df[&#39;user_agent&#39;]])</span>
<span class="sd">    ua_df.columns = &#39;ua_&#39; + ua_df.columns.str.replace(r&#39;user_agent.&#39;, &#39;&#39;, regex=True)</span>
<span class="sd">    ua_df.head(10)</span>

<span class="sd">====  ======================================================================================================================================================================================================  ===========  ==========  ==========  ==========  ==============  =============  =============  =============  ===================  ==================  =================  =================</span>
<span class="sd">  ..  ua_string                                                                                                                                                                                               ua_family      ua_major    ua_minor    ua_patch  ua_os.family      ua_os.major    ua_os.minor    ua_os.patch  ua_os.patch_minor    ua_device.family    ua_device.brand    ua_device.model</span>
<span class="sd">====  ======================================================================================================================================================================================================  ===========  ==========  ==========  ==========  ==============  =============  =============  =============  ===================  ==================  =================  =================</span>
<span class="sd">   0  Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.80 Mobile Safari/537.36 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)  Googlebot             2           1              Android                     6              0              1                       Spider              Spider             Smartphone</span>
<span class="sd">   1  Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36                                                                                               Chrome               81           0        4044  Linux                                                                             Other</span>
<span class="sd">   2  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36                                                                                      Chrome               90           0        4430  Windows                    10                                                     Other</span>
<span class="sd">   3  advertools/0.13.0                                                                                                                                                                                       Other                                            Other                                                                             Other</span>
<span class="sd">   4  advertools/0.13.0                                                                                                                                                                                       Other                                            Other                                                                             Other</span>
<span class="sd">   5  Mozilla/5.0 zgrab/0.x                                                                                                                                                                                   Other                                            Other                                                                             Other</span>
<span class="sd">   6  Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)                                                                                                                                Googlebot             2           1              Other                                                                             Spider              Spider             Desktop</span>
<span class="sd">   7  Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)                                                                                                                                Googlebot             2           1              Other                                                                             Spider              Spider             Desktop</span>
<span class="sd">   8  Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Chrome/98.0.4758.80 Safari/537.36                                                        Googlebot             2           1              Other                                                                             Spider              Spider             Desktop</span>
<span class="sd">   9  Mozilla/5.0 AppleWebKit/537.36 (KHTML, like Gecko; compatible; Googlebot/2.1; +http://www.google.com/bot.html) Chrome/98.0.4758.80 Safari/537.36                                                        Googlebot             2           1              Other                                                                             Spider              Spider             Desktop</span>
<span class="sd">====  ======================================================================================================================================================================================================  ===========  ==========  ==========  ==========  ==============  =============  =============  =============  ===================  ==================  =================  =================</span>

<span class="sd">Combine all data into one DataFrame and save to a new `.parquet` file.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    (pd.concat([logs_df, request_url_df, referer_url_df, ua_df], axis=1)</span>
<span class="sd">    .to_parquet(&#39;data/adv_logs_final.parquet&#39;, index=False, version=&#39;2.4&#39;))</span>


<span class="sd">Start the analysis.</span>

<span class="sd">The advantage of using the parquet format is that the file doens&#39;t need to be</span>
<span class="sd">loaded into memory, and can be queried from disk, just like querying a</span>
<span class="sd">database. This means you only load the columns that you select, and the rows</span>
<span class="sd">that satisfy certain conditions. For example we can load the</span>
<span class="sd">``ua_device.family`` and ``ua_family`` columns, and only the rows where</span>
<span class="sd">``&#39;ua_device.family&#39;, &#39;==&#39;, &#39;Spider&#39;``. We then count the values in the</span>
<span class="sd">``ua_family`` column, and get the top bots accessing our website.</span>

<span class="sd">.. thebe-button::</span>
<span class="sd">    Run this code</span>

<span class="sd">.. code-block::</span>
<span class="sd">    :class: thebe, thebe-init</span>

<span class="sd">    top_bots = pd.read_parquet(&#39;data/adv_logs_final.parquet&#39;,</span>
<span class="sd">                    filters=[</span>
<span class="sd">                        (&#39;ua_device.family&#39;, &#39;==&#39;, &#39;Spider&#39;)</span>
<span class="sd">                    ],</span>
<span class="sd">                    columns=[&#39;ua_device.family&#39;, &#39;ua_family&#39;])[&#39;ua_family&#39;].value_counts()</span>
<span class="sd">    top_bots[:15]</span>

<span class="sd">.. code-block::</span>

<span class="sd">    Googlebot      499</span>
<span class="sd">    PetalBot        46</span>
<span class="sd">    AhrefsBot       42</span>
<span class="sd">    Chrome          29</span>
<span class="sd">    YandexBot       29</span>
<span class="sd">    LinkedInBot     23</span>
<span class="sd">    Baiduspider     18</span>
<span class="sd">    DotBot          17</span>
<span class="sd">    Twitterbot      16</span>
<span class="sd">    bingbot         12</span>
<span class="sd">    MJ12bot         12</span>
<span class="sd">    Java            10</span>
<span class="sd">    Nutch            8</span>
<span class="sd">    masscan          6</span>
<span class="sd">    FacebookBot      4</span>
<span class="sd">    Name: ua_family, dtype: int64</span>

<span class="sd">Happy analyzing!</span>

<span class="sd">Parse and Analyze Crawl Logs in a Dataframe</span>
<span class="sd">===========================================</span>

<span class="sd">While crawling with the :func:`crawl` function, the process produces logs for</span>
<span class="sd">every page crawled, scraped, redirected, and even blocked by robots.txt rules.</span>

<span class="sd">By default, those logs are can be seen on the command line as their default</span>
<span class="sd">destination is stdout.</span>

<span class="sd">A good practice is to set a ``LOG_FILE`` so you can save those logs to a text</span>
<span class="sd">file, and review them later. There are several reasons why you might want to do</span>
<span class="sd">that:</span>

<span class="sd">* Blocked URLs: The crawler obeys robots.txt rules by default, and when it</span>
<span class="sd">  encounters pages that it shouldn&#39;t crawl, it doesn&#39;t. However, this is logged</span>
<span class="sd">  as an event, and you can easily extract a list of blocked URLs from the logs.</span>
<span class="sd">* Crawl errors: You might also get some errors while crawling, and it can be</span>
<span class="sd">  interesting to know which URLs generated errors.</span>
<span class="sd">* Filtered pages: Those are pages that were discovered but weren&#39;t crawled</span>
<span class="sd">  because they are not a sub-domain of the provided url_list, or happen to be</span>
<span class="sd">  on external domains altogether.</span>

<span class="sd">This can simply be done by specifying a file name through the optional</span>
<span class="sd">`custom_settings` parameter of ``crawl``:</span>

<span class="sd">&gt;&gt;&gt; import advertools as adv</span>
<span class="sd">&gt;&gt;&gt; adv.crawl(&#39;https://example.com&#39;,</span>
<span class="sd">              output_file=&#39;example.jl&#39;,</span>
<span class="sd">              follow_links=True,</span>
<span class="sd">              custom_settings={&#39;LOG_FILE&#39;: &#39;example.log&#39;})</span>

<span class="sd">If you run it this way, all logs will be saved to the file you chose,</span>
<span class="sd">`example.log` in this case.</span>

<span class="sd">Now, you can use the :func:`crawllogs_to_df` function to open the logs in a</span>
<span class="sd">DataFrame:</span>

<span class="sd">&gt;&gt;&gt; import advertools as adv</span>
<span class="sd">&gt;&gt;&gt; logs_df = adv.crawllogs_to_df(&quot;example.log&quot;)</span>


<span class="sd">The DataFrame might contain the following columns:</span>

<span class="sd">* `time`: The timestamp for the process</span>
<span class="sd">* `middleware`: The middleware responsible for this process, whether it is the</span>
<span class="sd">  core engine, the scraper, error handler and so on.</span>
<span class="sd">* `level`: The logging level (DEBUG, INFO, etc.)</span>
<span class="sd">* `message`: A single word summarizing what this row represents, &quot;Crawled&quot;,</span>
<span class="sd">  &quot;Scraped&quot;, &quot;Filtered&quot;, and so on.</span>
<span class="sd">* `domain`: The domain name of filtered (not crawled pages) typically for URLs</span>
<span class="sd">  outside the current website.</span>
<span class="sd">* `method`: The HTTP method used in this process (GET, PUT, etc.)</span>
<span class="sd">* `url`: The URL currently under process.</span>
<span class="sd">* `status`: HTTP status code, 200, 404, etc.</span>
<span class="sd">* `referer`: The referring URL, where applicable.</span>
<span class="sd">* `method_to`: In redirect rows the HTTP method used to crawl the URL going to.</span>
<span class="sd">* `redirect_to`: The URL redirected to.</span>
<span class="sd">* `method_from`: In redirect rows the HTTP method used to crawl the URL coming</span>
<span class="sd">  from.</span>
<span class="sd">* `redirect_from`: The URL redirected from.</span>
<span class="sd">* `blocked_urls`: The URLs that were not crawled due to robots.txt rules.</span>

<span class="sd">&quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">LOG_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^(?P&lt;client&gt;\S+) \S+ (?P&lt;userid&gt;\S+) \[(?P&lt;datetime&gt;[^\]]+)\] &quot;(?P&lt;method&gt;[A-Z]+) (?P&lt;request&gt;[^ &quot;]+)? HTTP/[0-9.]+&quot; (?P&lt;status&gt;[0-9]</span><span class="si">{3}</span><span class="s1">) (?P&lt;size&gt;[0-9]+|-)$&#39;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
    <span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^(?P&lt;client&gt;\S+) \S+ (?P&lt;userid&gt;\S+) \[(?P&lt;datetime&gt;[^\]]+)\] &quot;(?P&lt;method&gt;[A-Z]+) (?P&lt;request&gt;[^ &quot;]+)? HTTP/[0-9.]+&quot; (?P&lt;status&gt;[0-9]</span><span class="si">{3}</span><span class="s1">) (?P&lt;size&gt;[0-9]+|-) &quot;(?P&lt;referrer&gt;[^&quot;]*)&quot; &quot;(?P&lt;useragent&gt;[^&quot;]*)&quot;\s*$&#39;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
    <span class="s2">&quot;common_with_vhost&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^(?P&lt;vhost&gt;\S+) (?P&lt;client&gt;\S+) \S+ (?P&lt;userid&gt;\S+) \[(?P&lt;datetime&gt;[^\]]+)\] &quot;(?P&lt;method&gt;[A-Z]+) (?P&lt;request&gt;[^ &quot;]+)? HTTP/[0-9.]+&quot; (?P&lt;status&gt;[0-9]</span><span class="si">{3}</span><span class="s1">) (?P&lt;size&gt;[0-9]+|-)$&#39;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
    <span class="s2">&quot;nginx_error&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^(?P&lt;datetime&gt;\d</span><span class="si">{4}</span><span class="s2">/\d\d/\d\d \d\d:\d\d:\d\d) \[(?P&lt;level&gt;[^\]]+)\] (?P&lt;pid&gt;\d+)#(?P&lt;tid&gt;\d+): (?P&lt;counter&gt;\*\d+ | )?(?P&lt;message&gt;.*)&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
    <span class="s2">&quot;apache_error&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^(?P&lt;datetime&gt;\[[^\]]+\]) (?P&lt;level&gt;\[[^\]]+\]) \[pid (?P&lt;pid&gt;\d+)\] (?P&lt;file&gt;\S+):(?P&lt;status&gt; \S+| ):? \[client (?P&lt;client&gt;\S+)\] (?P&lt;message&gt;.*)&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E501</span>
<span class="p">}</span>

<span class="n">LOG_FIELDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="s2">&quot;userid&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">],</span>
    <span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;client&quot;</span><span class="p">,</span>
        <span class="s2">&quot;userid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;request&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;referer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;user_agent&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;common_with_vhost&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;virtual_host&quot;</span><span class="p">,</span>
        <span class="s2">&quot;client&quot;</span><span class="p">,</span>
        <span class="s2">&quot;userid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;request&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;size&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;nginx_error&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;process_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;thread_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;apache_error&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;process_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;client&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="n">LOG_DATE_FORMATS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%b/%Y:%H:%M:%S %z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;combined&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%b/%Y:%H:%M:%S %z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;common_with_vhost&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%b/%Y:%H:%M:%S %z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nginx_error&quot;</span><span class="p">:</span> <span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span>
    <span class="s2">&quot;apache_error&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2"> %Y&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="logs_to_df">
<a class="viewcode-back" href="../../advertools.logs.html#advertools.logs.logs_to_df">[docs]</a>
<span class="k">def</span> <span class="nf">logs_to_df</span><span class="p">(</span>
    <span class="n">log_file</span><span class="p">,</span>
    <span class="n">output_file</span><span class="p">,</span>
    <span class="n">errors_file</span><span class="p">,</span>
    <span class="n">log_format</span><span class="p">,</span>
    <span class="n">date_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and compress any log file into a DataFrame format.</span>

<span class="sd">    Convert a log file to a `parquet` file in a DataFrame format, and save all</span>
<span class="sd">    errors (or lines not conformig to the chosen log format) into a separate</span>
<span class="sd">    ``errors_file`` text file. Any non-JSON log format is possible, provided</span>
<span class="sd">    you have the right regex for it. A few default ones are provided and can be</span>
<span class="sd">    used. Check out ``adv.LOG_FORMATS`` and ``adv.LOG_FIELDS`` for the</span>
<span class="sd">    available formats and fields.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_file : str</span>
<span class="sd">      The path to the log file.</span>
<span class="sd">    output_file : str</span>
<span class="sd">      The path to the desired output file. Must have a &quot;.parquet&quot; extension, and must</span>
<span class="sd">      not have the same path as an existing file.</span>
<span class="sd">    errors_file : str</span>
<span class="sd">      The path where the parsing errors are stored. Any text format works, CSV is</span>
<span class="sd">      recommended to easily open it with any CSV reader with the separator as &quot;@@&quot;.</span>
<span class="sd">    log_format : str</span>
<span class="sd">      The name of one of the supported log formats, or a regex of your own format.</span>
<span class="sd">    fields : list</span>
<span class="sd">      A list of fields, which will become the names of columns in ``output_file``. Only</span>
<span class="sd">      required if you provide a custom (regex) ``log_format``.</span>
<span class="sd">    encoding : str</span>
<span class="sd">      The encoding of the log file. It defaults to utf-8, but you might need to try</span>
<span class="sd">      others in case of errors (latin-1, utf-16, etc.)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import advertools as adv</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; adv.logs_to_df(</span>
<span class="sd">    ...     log_file=&quot;access.log&quot;,</span>
<span class="sd">    ...     output_file=&quot;access_logs.parquet&quot;,</span>
<span class="sd">    ...     errors_file=&quot;log_errors.csv&quot;,</span>
<span class="sd">    ...     log_format=&quot;common&quot;,</span>
<span class="sd">    ...     fields=None,</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; logs_df = pd.read_parquet(&quot;access_logs.parquet&quot;)</span>

<span class="sd">    You can now analyze ``logs_df`` as a normal pandas DataFrame.</span>

<span class="sd">    :param str log_file: The path to the log file.</span>
<span class="sd">    :param str output_file: The path to the desired output file. Must have a</span>
<span class="sd">                            &quot;.parquet&quot; extension, and must not have the same</span>
<span class="sd">                            path as an existing file.</span>
<span class="sd">    :param str errors_file: The path where the parsing errors are stored. Any</span>
<span class="sd">                            text format works, CSV is recommended to easily</span>
<span class="sd">                            open it with any CSV reader with the separator as</span>
<span class="sd">                            &quot;@@&quot;.</span>
<span class="sd">    :param str log_format: Either the name of one of the supported log formats,</span>
<span class="sd">                           or a regex of your own format.</span>
<span class="sd">    :param str date_format: The date format in strftime format, in case you have a</span>
<span class="sd">                                a different one from the default.</span>
<span class="sd">    :param str fields: A list of fields, which will become the names of columns</span>
<span class="sd">                       in ``output_file``. Only required if you provide a</span>
<span class="sd">                       custom (regex) ``log_format``.</span>
<span class="sd">    :param str encoding: The encoding of the log file. It defaults to utf-8, but</span>
<span class="sd">                         you might need to try others in case of errors</span>
<span class="sd">                         (latin-1, utf-16, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Please provide an `output_file` with a `.parquet` &quot;</span> <span class="s2">&quot;extension.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">LOG_DATE_FORMATS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Please supply a value for the `fields` parameter when you provide a custom&quot;</span>
            <span class="s2">&quot;log format.&quot;</span>
        <span class="p">)</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">LOG_FORMATS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span> <span class="ow">or</span> <span class="n">log_format</span>
    <span class="n">date_fmt</span> <span class="o">=</span> <span class="n">date_format</span> <span class="ow">or</span> <span class="n">LOG_DATE_FORMATS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">log_format</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">or</span> <span class="n">LOG_FIELDS</span><span class="p">[</span><span class="n">log_format</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">tempdir_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
            <span class="n">parsed_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log_line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">parsed_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_line</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempdir_name</span> <span class="o">/</span> <span class="s2">&quot;errors.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;at&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;@@&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]),</span> <span class="n">file</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">250_000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">&gt;15,</span><span class="si">}</span><span class="s2"> lines.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parsed_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">tempdir_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
                    <span class="n">parsed_lines</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">&gt;15,</span><span class="si">}</span><span class="s2"> lines.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempdir_name</span> <span class="o">/</span> <span class="s2">&quot;errors.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">err_final</span><span class="p">:</span>
                        <span class="n">err_content</span> <span class="o">=</span> <span class="n">err_final</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">errors_file</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">errout</span><span class="p">:</span>
                            <span class="n">errout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err_content</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempdir_name</span> <span class="o">/</span> <span class="s2">&quot;errors.txt&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parsed_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">tempdir_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;file_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
            <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tempdir_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">final_df</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="n">date_fmt</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
                <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
                <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span>
                    <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;signed&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">final_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2.6&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="crawllogs_to_df">
<a class="viewcode-back" href="../../advertools.logs.html#advertools.logs.crawllogs_to_df">[docs]</a>
<span class="k">def</span> <span class="nf">crawllogs_to_df</span><span class="p">(</span><span class="n">logs_file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a crawl logs file to a DataFrame.</span>

<span class="sd">    An interesting option while using the ``crawl`` function, is to specify a</span>
<span class="sd">    destination file to save the logs of the crawl process itself. This contains</span>
<span class="sd">    additional information about each crawled, scraped, blocked, or redirected</span>
<span class="sd">    URL.</span>

<span class="sd">    What you would most likely use this for is to get a list of URLs blocked by</span>
<span class="sd">    robots.txt rules. These can be found und the column ``blocked_urls``.</span>
<span class="sd">    Crawling errors are also interesting, and can be found in rows where</span>
<span class="sd">    ``message`` is equal to &quot;error&quot;.</span>

<span class="sd">    &gt;&gt;&gt; import advertools as adv</span>
<span class="sd">    &gt;&gt;&gt; adv.crawl(&#39;https://example.com&#39;,</span>
<span class="sd">                  output_file=&#39;example.jl&#39;,</span>
<span class="sd">                  follow_links=True,</span>
<span class="sd">                  custom_settings={&#39;LOG_FILE&#39;: &#39;example.log&#39;})</span>
<span class="sd">    &gt;&gt;&gt; logs_df = adv.crawl_logs_to_df(&quot;example.log&quot;)</span>


<span class="sd">    :param str logs_file_path: The path to the logs file.</span>

<span class="sd">    :returns DataFrame crawl_logs_df: A DataFrame summarizing the logs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_middleware_level</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\d</span><span class="si">{4}</span><span class="s2">-\d\d-\d\d \d\d:\d\d:\d\d) \[(.*?)\] ([A-Z]+): &quot;</span>
    <span class="n">time_middleware_level_error</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;(\d</span><span class="si">{4}</span><span class="s2">-\d\d-\d\d \d\d:\d\d:\d\d) \[(.*?)\] (ERROR): &quot;</span>
    <span class="p">)</span>

    <span class="n">filtered_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time_middleware_level</span>
        <span class="o">+</span> <span class="s2">&quot;(Filtered) offsite request to &#39;(.*?)&#39;: &lt;([A-Z]+) (.*?)&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">filtered_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;middleware&quot;</span><span class="p">,</span>
        <span class="s2">&quot;level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="s2">&quot;domain&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">crawled_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time_middleware_level</span>
        <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(Crawled) \((\d\d\d)\) &lt;([A-Z]+) (.*?)&gt; \(referer: (.*?)\)&quot;</span>
    <span class="p">)</span>
    <span class="n">crawled_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;middleware&quot;</span><span class="p">,</span>
        <span class="s2">&quot;level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;referer&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">scraped_regex</span> <span class="o">=</span> <span class="n">time_middleware_level</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(Scraped) from &lt;(\d\d\d) (.*?)&gt;&quot;</span>
    <span class="n">scraped_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;middleware&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">]</span>

    <span class="n">redirect_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time_middleware_level</span>
        <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(Redirect)ing \((\d\d\d)\) to &lt;([A-Z]+) (.*?)&gt; from &lt;([A-Z]+) (.*?)&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">redirect_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;middleware&quot;</span><span class="p">,</span>
        <span class="s2">&quot;level&quot;</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method_to&quot;</span><span class="p">,</span>
        <span class="s2">&quot;redirect_to&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method_from&quot;</span><span class="p">,</span>
        <span class="s2">&quot;redirect_from&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">blocked_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time_middleware_level</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(Forbidden) by robots\.txt: &lt;([A-Z]+) (.*?)&gt;&quot;</span>
    <span class="p">)</span>
    <span class="n">blocked_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;middleware&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;blocked_urls&quot;</span><span class="p">]</span>

    <span class="n">error_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">time_middleware_level</span>
        <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;Spider (error) processing &lt;([A-Z]+) (.*?)&gt; \(referer: (.*?)\)&quot;</span>
    <span class="p">)</span>
    <span class="n">error_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;middleware&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;referer&quot;</span><span class="p">]</span>

    <span class="n">error_level_regex</span> <span class="o">=</span> <span class="n">time_middleware_level_error</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(.*)? (\d\d\d) (http.*)&quot;</span>
    <span class="n">error_level_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;middleware&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">]</span>

    <span class="n">generic_error_regex</span> <span class="o">=</span> <span class="n">time_middleware_level_error</span> <span class="o">+</span> <span class="s2">&quot;(.*)&quot;</span>
    <span class="n">generic_error_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;middleware&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">]</span>

    <span class="n">filtered_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crawled_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scraped_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">redirect_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">blocked_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_lvl_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">generic_error_lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logs_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">filtered_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">filtered_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">crawled_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">crawled_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">crawled_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">scraped_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">scraped_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">scraped_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">redirect_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">redirect_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">redirect_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">blocked_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">blocked_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">blocked_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">error_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">error_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">error_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">error_level_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">error_lvl_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">error_level_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">generic_error_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">generic_error_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">generic_error_regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filtered_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">filtered_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">crawled_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">crawled_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scraped_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">scraped_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">redirect_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">redirect_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">blocked_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">blocked_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">error_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_lvl_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">error_level_cols</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">generic_error_lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">generic_error_cols</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Elias Dabbas.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>