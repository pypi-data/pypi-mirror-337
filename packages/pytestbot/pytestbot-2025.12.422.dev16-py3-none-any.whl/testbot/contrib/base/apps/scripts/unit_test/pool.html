<!DOCTYPE html>
<html lang="en">
<body>
<script src="https://cdn.jsdelivr.net/npm/gojs@3.0.16/release/go.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<div id="allSampleContent" class="p-4 w-full">

    <script id="code">
        function init() {

          myDiagram = new go.Diagram('myDiagramDiv', {
            // For this sample, automatically show the state of the diagram's model on the page
            ModelChanged: (e) => {
              if (e.isTransactionFinished) showModel();
            },
            'undoManager.isEnabled': true
          });

          const UnselectedBrush = 'lightgray'; // item appearance, if not "selected"
          const SelectedBrush = 'dodgerblue'; // item appearance, if "selected"

          function isPortSelected(item) {
            return item && item.fill !== UnselectedBrush; // assume the port is a Shape
          }

          function setPortSelected(item, sel) {
            if (!item) return;
            if (sel) {
              item.fill = SelectedBrush;
            } else {
              item.fill = UnselectedBrush;
            }
          }

          function onPortClick(e, tb) {
            var shape = tb.panel.findObject('SHAPE');
            if (shape !== null) {
              var oldskips = shape.diagram.skipsUndoManager;
              shape.diagram.skipsUndoManager = true;
              if (e.control || e.meta) {
                setPortSelected(shape, !isPortSelected(shape));
                shape.part.isSelected = shape.part.ports.any(isPortSelected);
              } else if (e.shift) {
                // alternative policy: select all Ports between this item and some other one??
                if (!isPortSelected(shape)) setPortSelected(shape, true);
                shape.part.isSelected = true;
              } else {
                if (!isPortSelected(shape)) {
                  // deselect all sibling items
                  shape.part.ports.each((it) => {
                    if (it !== shape) setPortSelected(it, false);
                  });
                  setPortSelected(shape, true);
                }
                shape.part.isSelected = true;
              }
              shape.diagram.skipsUndoManager = oldskips;
            }
          }

          function makeItemTemplate(leftside) {
            return new go.Panel('Auto', { margin: new go.Margin(1, 0) }) // some space between ports
              .add(
                new go.Shape({
                  name: 'SHAPE',
                  fill: UnselectedBrush,
                  stroke: 'gray',
                  geometryString: 'F1 m 0,0 l 5,0 1,4 -1,4 -5,0 1,-4 -1,-4 z',
                  spot1: new go.Spot(0, 0, 5, 1), // keep the text inside the shape
                  spot2: new go.Spot(1, 1, -5, 0),
                  // some port-related properties
                  toSpot: go.Spot.Left,
                  toLinkable: leftside,
                  fromSpot: go.Spot.Right,
                  fromLinkable: !leftside,
                  cursor: 'pointer'
                })
                  .bind('portId', 'name'),
                new go.TextBlock({
                  // allow the user to select items -- the background color indicates whether "selected"
                  isActionable: true,
                  click: onPortClick
                })
                  .bind('text', 'name')
              );
          }

          myDiagram.nodeTemplate = new go.Node('Spot', {
            selectionAdorned: false,
            locationSpot: go.Spot.Center,
            locationObjectName: 'BODY'
          })
            .bindTwoWay('location', 'loc', go.Point.parse, go.Point.stringify)
            .add(
              new go.Panel('Auto', { name: 'BODY' })
                .add(
                  new go.Shape('RoundedRectangle', {
                    stroke: 'gray',
                    strokeWidth: 2,
                    fill: 'transparent'
                  })
                    .bindObject('stroke', 'isSelected', (b) => (b ? SelectedBrush : UnselectedBrush)),
                  new go.Panel('Vertical', { margin: 6 })
                    .add(
                      new go.TextBlock({ alignment: go.Spot.Left })
                        .bind('text', 'name'),
                      new go.Picture('images/60x90.png', {
                        width: 30,
                        height: 45,
                        margin: new go.Margin(10, 10)
                      })
                    )
                ),
              new go.Panel('Vertical', {
                name: 'LEFTPORTS',
                alignment: new go.Spot(0, 0.5, 0, 7),
                itemTemplate: makeItemTemplate(true)
              })
                .bind('itemArray', 'inservices'),
              new go.Panel('Vertical', {
                name: 'RIGHTPORTS',
                alignment: new go.Spot(1, 0.5, 0, 7),
                itemTemplate: makeItemTemplate(false)
              })
                .bind('itemArray', 'outservices')
            );

          myDiagram.linkTemplate = new go.Link({
            routing: go.Routing.Orthogonal,
            corner: 10,
            toShortLength: -3,
            relinkableFrom: true,
            relinkableTo: true,
            reshapable: true,
            resegmentable: true
          })
            .add(
              new go.Shape({
                stroke: 'gray',
                strokeWidth: 2.5
              })
            );

          function findAllSelectedItems() {
            var items = [];
            for (var nit = myDiagram.nodes; nit.next(); ) {
              var node = nit.value;
              //?? Maybe this should only return selected items that are within selected Nodes
              //if (!node.isSelected) continue;
              node.ports.each((port) => {
                if (isPortSelected(port)) items.push(port.findBindingPanel());
              });
            }
            return items;
          }

          // Override the standard CommandHandler deleteSelection and canDeleteSelection behavior.
          // If there are any selected items, delete them instead of deleting any selected nodes or links.

          myDiagram.commandHandler.canDeleteSelection = function () {
            // method override must be function, not =>
            // true if there are any selected deletable nodes or links,
            // or if there are any selected items within nodes
            return go.CommandHandler.prototype.canDeleteSelection.call(this) || findAllSelectedItems().length > 0;
          };

          myDiagram.commandHandler.deleteSelection = function () {
            // method override must be function, not =>
            var items = findAllSelectedItems();
            if (items.length > 0) {
              // if there are any selected items, delete them
              myDiagram.startTransaction('delete items');
              for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var nodedata = item.part.data;
                var itemdata = item.data;
                // find the item array that the item data is in; try "inservices" first
                var itemarray = nodedata.inservices;
                var itemindex = itemarray.indexOf(itemdata);
                if (itemindex < 0) {
                  // otherwise try "outservices"
                  itemarray = nodedata.outservices;
                  itemindex = itemarray.indexOf(itemdata);
                }
                if (itemindex >= 0) {
                  myDiagram.model.removeArrayItem(itemarray, itemindex);
                }
              }
              myDiagram.commitTransaction('delete items');
            } else {
              // otherwise just delete nodes and/or links, as usual
              go.CommandHandler.prototype.deleteSelection.call(this);
            }
          };

          myDiagram.model = new go.GraphLinksModel({
            copiesArrays: true,
            copiesArrayObjects: true,
            linkFromPortIdProperty: 'fromPort',
            linkToPortIdProperty: 'toPort',
            nodeDataArray: [
              { key: 1, name: 'M70JP90W', inservices: [], outservices: [{ name: 'COM7' }, { name: 'COM18' }], loc: '0 0' },
              { key: 2, name: '5C0AD0760BB0C50AD', inservices: [{ name: 'CommSerialPort' }, { name: 'InfraredSerialPort' }], loc: '500 0' }
            ],
            linkDataArray: [{ from: 1, fromPort: 'COM7', to: 2, toPort: 'CommSerialPort' }, { from: 1, fromPort: 'COM18', to: 2, toPort: 'InfraredSerialPort' }]
          });

          showModel();

          function showModel() {
            document.getElementById('mySavedModel').innerHTML = myDiagram.model.toJson();
            if (window.Prism) window.Prism.highlightAll();
          }
        }
        window.addEventListener('DOMContentLoaded', init);
    </script>

    <div id="sample">
        <div id="myDiagramDiv" style="border: solid 1px black; width: 100%; height: 600px"></div>
        <pre class="lang-js"><code id="mySavedModel"></code></pre>
    </div>
</div>
</body>
</html>